<!DOCTYPE html> <html lang=en  data-content_root="../"> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=viewport  content="width=device-width, initial-scale=1" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151397036-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-151397036-1'); </script> <title>Predicting Mortgage Delinquency Risk &#8212; Unifying Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css?v=649a27d8" /> <link rel=stylesheet  type="text/css" href="../_static/material.css?v=79c92029" /> <link rel=stylesheet  type="text/css" href="../_static/nbsphinx-code-cells.css?v=14571329" /> <script src="../_static/documentation_options.js?v=5929fcd5"></script> <script src="../_static/doctools.js?v=888ff710"></script> <script src="../_static/sphinx_highlight.js?v=dc90522c"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel=icon  href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#exercises/solutions_passive_prediction" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Unifying Data Science" class="md-header-nav__button md-logo"> &nbsp; </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Unifying Data Science</span> <span class=md-header-nav__topic > Predicting Mortgage Delinquency Risk </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=""Search"" autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Unifying Data Science" class="md-nav__button md-logo"> <img src="../_static/" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Unifying Data Science">Unifying Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >CLASS SCHEDULE</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Causal Inference</span></span> <li class=md-nav__item > <a href="../limitations_of_ATE.html" class=md-nav__link >Limitations of ATE</a> <li class=md-nav__item > <a href="../internal_v_external_validity.html" class=md-nav__link >Internal v. External Validity</a> <li class=md-nav__item > <a href="../evaluating_real_studies.html" class=md-nav__link >Evaluating A Real Study</a> <li class=md-nav__item > <a href="../causal_inference_beyond_ab_testing.html" class=md-nav__link >Beyond AB Testing</a> <li class=md-nav__item > <a href="../matching_why.html" class=md-nav__link >Matching (Why)</a> <li class=md-nav__item > <a href="../matching_how.html" class=md-nav__link >Matching (How)</a> <li class=md-nav__item > <a href="../interpreting_indicator_vars.html" class=md-nav__link >Indicator Variables</a> <li class=md-nav__item > <a href="../fixed_effects.html" class=md-nav__link >Fixed Effects (FEs)</a> <li class=md-nav__item > <a href="../fixed_effects_and_causal_inference.html" class=md-nav__link >FEs & Causality</a> <li class=md-nav__item > <a href="../fixed_effects_v_hierarchical.html" class=md-nav__link >FEs & Hierarchical Models</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Data Science Project Design</span></span> <li class=md-nav__item > <a href="../backwards_design.html" class=md-nav__link >Backwards Design</a> <li class=md-nav__item > <a href="../taxonomy_of_questions.html" class=md-nav__link >Taxonomy of Questions</a> <li class=md-nav__item > <a href="../moving_from_problems_to_questions.html" class=md-nav__link >From Problems to Questions</a> <li class=md-nav__item > <a href="../descriptive_questions.html" class=md-nav__link >Discretion and Description</a> <li class=md-nav__item > <a href="../ethical_ml_recommendations.html" class=md-nav__link >Ethical Machine Learning</a> <li class=md-nav__item > <a href="../writing_to_stakeholders.html" class=md-nav__link >Writing for Lay Audiences</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >"Contents"</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#exercises-solutions-passive-prediction--page-root" class=md-nav__link >Predicting Mortgage Delinquency Risk</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Gradescope-Autograding" class=md-nav__link >Gradescope Autograding</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Submission-Limits" class=md-nav__link >Submission Limits</a> </ul> </nav> <li class=md-nav__item ><a href="#Data-Cleaning-and-Organization" class=md-nav__link >Data Cleaning and Organization</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-1" class=md-nav__link >Exercise 1</a> <li class=md-nav__item ><a href="#Exercise-2" class=md-nav__link >Exercise 2</a> <li class=md-nav__item ><a href="#Exercise-3" class=md-nav__link >Exercise 3</a> <li class=md-nav__item ><a href="#Exercise-4" class=md-nav__link >Exercise 4</a> <li class=md-nav__item ><a href="#Exercise-5" class=md-nav__link >Exercise 5</a> <li class=md-nav__item ><a href="#Exercise-6" class=md-nav__link >Exercise 6</a> <li class=md-nav__item ><a href="#Exercise-7" class=md-nav__link >Exercise 7</a> </ul> </nav> <li class=md-nav__item ><a href="#Modelling-Delinquency-Risk" class=md-nav__link >Modelling Delinquency Risk</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-8" class=md-nav__link >Exercise 8</a> <li class=md-nav__item ><a href="#Exercise-9" class=md-nav__link >Exercise 9</a> <li class=md-nav__item ><a href="#Exercise-10" class=md-nav__link >Exercise 10</a> <li class=md-nav__item ><a href="#Exercise-11" class=md-nav__link >Exercise 11</a> <li class=md-nav__item ><a href="#Exercise-12" class=md-nav__link >Exercise 12</a> <li class=md-nav__item ><a href="#Exercise-13" class=md-nav__link >Exercise 13</a> <li class=md-nav__item ><a href="#Exercise-14" class=md-nav__link >Exercise 14</a> <li class=md-nav__item ><a href="#Exercise-15" class=md-nav__link >Exercise 15</a> </ul> </nav> <li class=md-nav__item ><a href="#Now-To-The-Future" class=md-nav__link >Now To The Future</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-16" class=md-nav__link >Exercise 16</a> <li class=md-nav__item ><a href="#Exercise-17" class=md-nav__link >Exercise 17</a> <li class=md-nav__item ><a href="#Exercise-18" class=md-nav__link >Exercise 18</a> </ul> </nav> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <section id=Predicting-Mortgage-Delinquency-Risk > <h1 id=exercises-solutions-passive-prediction--page-root >Predicting Mortgage Delinquency Risk<a class=headerlink  href="#exercises-solutions-passive-prediction--page-root" title="Link to this heading">¶</a></h1> <p><strong>Note: this is a new exercise, so if you find something weird, please bring it to my attention.</strong></p> <p>You have been hired by a mortgage servicing firm (a company that buys mortgages and then collects mortgage payments from homeowners) to build a model to answer the question:</p> <p><strong>Given all available information about a newly issued mortgage, what is the likelihood that the mortgage will enter delinquency (the homeowner will be at least 30 days late on a mortgage payment) during the first two years of the mortgage?</strong></p> <p>The servicer’s hope, obviously, is to differentiate between mortgages to try and purchase (those that will be consistently paid) and mortgages they wish to avoid.</p> <p>For this task, you have been given <a class="reference external" href="https://www.freddiemac.com/research/datasets/sf-loanlevel-dataset">REAL data on a sample of all US Standard single family home mortgages purchased or insured by Freddie Mac</a> in a single calendar year along with payment data from that and two subsequent years.</p> <section id=Gradescope-Autograding > <h2 id=Gradescope-Autograding >Gradescope Autograding<a class=headerlink  href="#Gradescope-Autograding" title="Link to this heading">¶</a></h2> <p>Please follow <a class="reference external" href="https://www.practicaldatascience.org/html/autograder_guidelines.html">all standard guidance</a> for submitting this assignment to the Gradescope autograder, including storing your solutions in a dictionary called <code class="docutils literal notranslate"><span class=pre >results</span></code> and ensuring your notebook runs from the start to completion without any errors.</p> <p>For this assignment, please name your file <code class="docutils literal notranslate"><span class=pre >exercise_passive_prediction.ipynb</span></code> before uploading.</p> <p>You can check that you have answers for all questions in your <code class="docutils literal notranslate"><span class=pre >results</span></code> dictionary with this code:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=k >assert</span> <span class=nb >set</span><span class=p >(</span><span class=n >results</span><span class=o >.</span><span class=n >keys</span><span class=p >())</span> <span class=o >==</span> <span class=p >{</span>
    <span class=s2 >"ex2_merge_type"</span><span class=p >,</span>
    <span class=s2 >"ex4_num_mortgages"</span><span class=p >,</span>
    <span class=s2 >"ex5_num_obs"</span><span class=p >,</span>
    <span class=s2 >"ex7_num_mortgages"</span><span class=p >,</span>
    <span class=s2 >"ex7_share_delinquent"</span><span class=p >,</span>
    <span class=s2 >"ex10_num_obs"</span><span class=p >,</span>
    <span class=s2 >"ex12_roc_auc"</span><span class=p >,</span>
    <span class=s2 >"ex14_false_omission_rate"</span><span class=p >,</span>
    <span class=s2 >"ex16_num_obs"</span><span class=p >,</span>
    <span class=s2 >"ex16_share_delinquent"</span><span class=p >,</span>
    <span class=s2 >"ex17_false_omission_rate"</span><span class=p >,</span>
<span class=p >}</span>
</pre></div> </div> <section id=Submission-Limits > <h3 id=Submission-Limits >Submission Limits<a class=headerlink  href="#Submission-Limits" title="Link to this heading">¶</a></h3> <p>Please remember that you are <strong>only allowed FOUR submissions to the autograder.</strong> Your last submission (if you submit 4 or fewer times), or your third submission (if you submit more than 4 times) will determine your grade Submissions that error out will <strong>not</strong> count against this total.</p> <p>That’s one more than usual in case there are issues with exercise clarity.</p> </section> </section> <section id=Data-Cleaning-and-Organization > <h2 id=Data-Cleaning-and-Organization >Data Cleaning and Organization<a class=headerlink  href="#Data-Cleaning-and-Organization" title="Link to this heading">¶</a></h2> <p>Data for this exercise can be <a class="reference external" href="https://github.com/nickeubank/MIDS_Data/tree/master/mortgages/2004">found here</a>. This folder includes both the data to be used and documentation, though you can find <a class="reference external" href="https://www.freddiemac.com/research/datasets/sf-loanlevel-dataset">supplemental documentation here</a>.</p> <p>The only difference between this data and the original Freddie Mac sampled data is that I’ve limited the scope of service data to three calendar years.</p> <section id=Exercise-1 > <h3 id=Exercise-1 >Exercise 1<a class=headerlink  href="#Exercise-1" title="Link to this heading">¶</a></h3> <p>Begin by loading both:</p> <ul class=simple > <li><p>the mortgage origination file (<code class="docutils literal notranslate"><span class=pre >sample_orig_2004.txt</span></code>). This <em>should</em> contain information on all mortgages issued in 2004, along with non-time varying features of these mortgages (the initial amount, the credit score of the applicant, etc.), and</p> <li><p>the servicing data (<code class="docutils literal notranslate"><span class=pre >sample_svcg_2004orig_3years.txt</span></code>). This contains monthly records of all recorded payments (or non-payments) for all mortgages issued in 2004 during the calendar years of 2004, 2005, and 2006.</p> </ul> <p>So the autograder can see the data, be sure to load it directly from a URL (don’t download and load from your own system).</p> <p>Load the data AND ensure your data has column names. You will likely need to reference the documentation to figure out how to do so.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>
<span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>

<span class=n >pd</span><span class=o >.</span><span class=n >set_option</span><span class=p >(</span><span class=s2 >"mode.copy_on_write"</span><span class=p >,</span> <span class=kc >True</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >origination_colnames</span> <span class=o >=</span> <span class=p >[</span>
    <span class=s2 >"Credit Score"</span><span class=p >,</span>
    <span class=s2 >"First Payment Date"</span><span class=p >,</span>
    <span class=s2 >"First Time Homebuyer Flag"</span><span class=p >,</span>
    <span class=s2 >"Maturity Date"</span><span class=p >,</span>
    <span class=s2 >"Metropolitan Statistical Area (MSA) Or Metropolitan Division"</span><span class=p >,</span>
    <span class=s2 >"Mortgage Insurance Percentage (MI %)"</span><span class=p >,</span>
    <span class=s2 >"Number of Units"</span><span class=p >,</span>
    <span class=s2 >"Occupancy Status"</span><span class=p >,</span>
    <span class=s2 >"Original Combined Loan-to-Value (CLTV)"</span><span class=p >,</span>
    <span class=s2 >"Original Debt-to-Income (DTI) Ratio"</span><span class=p >,</span>
    <span class=s2 >"Original UPB"</span><span class=p >,</span>
    <span class=s2 >"Original Loan-to-Value (LTV)"</span><span class=p >,</span>
    <span class=s2 >"Original Interest Rate"</span><span class=p >,</span>
    <span class=s2 >"Channel"</span><span class=p >,</span>
    <span class=s2 >"Prepayment Penalty Mortgage (PPM) Flag"</span><span class=p >,</span>
    <span class=s2 >"Amortization Type (Formerly Product Type)"</span><span class=p >,</span>
    <span class=s2 >"Property State"</span><span class=p >,</span>
    <span class=s2 >"Property Type"</span><span class=p >,</span>
    <span class=s2 >"Postal Code"</span><span class=p >,</span>
    <span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=s2 >"Loan Purpose"</span><span class=p >,</span>
    <span class=s2 >"Original Loan Term"</span><span class=p >,</span>
    <span class=s2 >"Number of Borrowers"</span><span class=p >,</span>
    <span class=s2 >"Seller Name"</span><span class=p >,</span>
    <span class=s2 >"Servicer Name"</span><span class=p >,</span>
    <span class=s2 >"Super Conforming Flag"</span><span class=p >,</span>
    <span class=s2 >"Pre-HARP Loan Sequence Number"</span><span class=p >,</span>
    <span class=s2 >"Program Indicator"</span><span class=p >,</span>
    <span class=s2 >"HARP Indicator"</span><span class=p >,</span>
    <span class=s2 >"Property Valuation Method"</span><span class=p >,</span>
    <span class=s2 >"Interest Only (I/O) Indicator"</span><span class=p >,</span>
    <span class=s2 >"Mortgage Insurance Cancellation Indicator"</span><span class=p >,</span>
<span class=p >]</span>
</pre></div> </div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >service_colnames</span> <span class=o >=</span> <span class=p >[</span>
    <span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=s2 >"Monthly Reporting Period"</span><span class=p >,</span>
    <span class=s2 >"Current Actual UPB"</span><span class=p >,</span>
    <span class=s2 >"Current Loan Delinquency Status"</span><span class=p >,</span>
    <span class=s2 >"Loan Age"</span><span class=p >,</span>
    <span class=s2 >"Remaining Months to Legal Maturity"</span><span class=p >,</span>
    <span class=s2 >"Defect Settlement Date"</span><span class=p >,</span>
    <span class=s2 >"Modification Flag"</span><span class=p >,</span>
    <span class=s2 >"Zero Balance Code"</span><span class=p >,</span>
    <span class=s2 >"Zero Balance Effective Date"</span><span class=p >,</span>
    <span class=s2 >"Current Interest Rate"</span><span class=p >,</span>
    <span class=s2 >"Current Deferred UPB"</span><span class=p >,</span>
    <span class=s2 >"Due Date of Last Paid Installment (DDLPI)"</span><span class=p >,</span>
    <span class=s2 >"MI Recoveries"</span><span class=p >,</span>
    <span class=s2 >"Net Sales Proceeds"</span><span class=p >,</span>
    <span class=s2 >"Non MI Recoveries"</span><span class=p >,</span>
    <span class=s2 >"Expenses"</span><span class=p >,</span>
    <span class=s2 >"Legal Costs"</span><span class=p >,</span>
    <span class=s2 >"Maintenance and Preservation Costs"</span><span class=p >,</span>
    <span class=s2 >"Taxes and Insurance"</span><span class=p >,</span>
    <span class=s2 >"Miscellaneous Expenses"</span><span class=p >,</span>
    <span class=s2 >"Actual Loss Calculation"</span><span class=p >,</span>
    <span class=s2 >"Modification Cost"</span><span class=p >,</span>
    <span class=s2 >"Step Modification Flag"</span><span class=p >,</span>
    <span class=s2 >"Deferred Payment Plan"</span><span class=p >,</span>
    <span class=s2 >"Estimated Loan-to-Value (ELTV)"</span><span class=p >,</span>
    <span class=s2 >"Zero Balance Removal UPB"</span><span class=p >,</span>
    <span class=s2 >"Delinquent Accrued Interest"</span><span class=p >,</span>
    <span class=s2 >"Delinquency Due to Disaster"</span><span class=p >,</span>
    <span class=s2 >"Borrower Assistance Status Code"</span><span class=p >,</span>
    <span class=s2 >"Current Month Modification Cost"</span><span class=p >,</span>
    <span class=s2 >"Interest Bearing UPB"</span><span class=p >,</span>
<span class=p >]</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >mortgages</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span>
    <span class=s2 >"https://github.com/nickeubank/MIDS_Data/raw/master/mortgages/2004/sample_orig_2004.txt"</span><span class=p >,</span>
    <span class=n >sep</span><span class=o >=</span><span class=s2 >"|"</span><span class=p >,</span>
    <span class=n >names</span><span class=o >=</span><span class=n >origination_colnames</span><span class=p >,</span>
<span class=p >)</span>
<span class=n >servicing</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span>
    <span class=s2 >"https://github.com/nickeubank/MIDS_Data/raw/master/mortgages/2004/sample_svcg_2004orig_3years.txt"</span><span class=p >,</span>
    <span class=n >sep</span><span class=o >=</span><span class=s2 >"|"</span><span class=p >,</span>
    <span class=n >names</span><span class=o >=</span><span class=n >service_colnames</span><span class=p >,</span>
<span class=p >)</span>

<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"2004 data has </span><span class=si >{</span><span class=nb >len</span><span class=p >(</span><span class=n >mortgages</span><span class=p >)</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > new mortgages"</span><span class=p >)</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"2004 data has </span><span class=si >{</span><span class=nb >len</span><span class=p >(</span><span class=n >servicing</span><span class=p >)</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > servicing records"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
2004 data has 50,000 new mortgages
2004 data has 1,287,161 servicing records
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/fs/h_8_rwsn5hvg9mhp0txgc_s9v6191b/T/ipykernel_20548/3651092739.py:6: DtypeWarning: Columns (4,8,24) have mixed types. Specify dtype option on import or set low_memory=False.
  servicing = pd.read_csv(
</pre></div></div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Life becomes way easier if I add this here,</span>
<span class=c1 ># though you may not realize it till</span>
<span class=c1 ># around exercise 7</span>
<span class=n >servicing</span> <span class=o >=</span> <span class=n >servicing</span><span class=p >[</span>
    <span class=p >[</span>
        <span class=s2 >"Monthly Reporting Period"</span><span class=p >,</span>
        <span class=s2 >"Current Loan Delinquency Status"</span><span class=p >,</span>
        <span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=p >]</span>
<span class=p >]</span>
</pre></div> </div> </div> </section> <section id=Exercise-2 > <h3 id=Exercise-2 >Exercise 2<a class=headerlink  href="#Exercise-2" title="Link to this heading">¶</a></h3> <p>What is the unit of observation in <code class="docutils literal notranslate"><span class=pre >sample_orig_2004.txt</span></code> and in <code class="docutils literal notranslate"><span class=pre >sample_svcg_2004orig_3years.txt</span></code>?</p> </section> <section id=Exercise-3 > <h3 id=Exercise-3 >Exercise 3<a class=headerlink  href="#Exercise-3" title="Link to this heading">¶</a></h3> <p>Merge your two datasets. Be sure to use the <code class="docutils literal notranslate"><span class=pre >validate</span></code> keyword argument in <code class="docutils literal notranslate"><span class=pre >merge</span></code>.</p> <p>You will find some records in the origination files not in the servicing file. We need data from both files, so just do an <code class="docutils literal notranslate"><span class=pre >inner</span></code> join.</p> <p>Assuming that you list the data associated with <code class="docutils literal notranslate"><span class=pre >sample_orig_2004.txt</span></code> first and <code class="docutils literal notranslate"><span class=pre >sample_svcg_2004orig_3years.txt</span></code> second, what keyword are you passing to <code class="docutils literal notranslate"><span class=pre >validate</span></code>? Store your answer as a string (use one of: <code class="docutils literal notranslate"><span class=pre >"1:1"</span></code>, <code class="docutils literal notranslate"><span class=pre >"m:1"</span></code>, <code class="docutils literal notranslate"><span class=pre >"1:m"</span></code>, <code class="docutils literal notranslate"><span class=pre >"m:m"</span></code>) in a dictionary called <code class="docutils literal notranslate"><span class=pre >results</span></code> under the key <code class="docutils literal notranslate"><span class=pre >ex2_merge_type</span></code>.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >results</span> <span class=o >=</span> <span class=p >{}</span>
<span class=n >results</span><span class=p >[</span><span class=s2 >"ex2_merge_type"</span><span class=p >]</span> <span class=o >=</span> <span class=s2 >"1:m"</span>
</pre></div> </div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >combined</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >merge</span><span class=p >(</span>
    <span class=n >mortgages</span><span class=p >,</span>
    <span class=n >servicing</span><span class=p >,</span>
    <span class=n >on</span><span class=o >=</span><span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=n >how</span><span class=o >=</span><span class=s2 >"inner"</span><span class=p >,</span>
    <span class=n >validate</span><span class=o >=</span><span class=s2 >"1:m"</span><span class=p >,</span>
    <span class=n >indicator</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
<span class=p >)</span>
<span class=n >combined</span><span class=o >.</span><span class=n >_merge</span><span class=o >.</span><span class=n >value_counts</span><span class=p >()</span>
<span class=k >assert</span> <span class=p >(</span><span class=n >combined</span><span class=o >.</span><span class=n >_merge</span> <span class=o >!=</span> <span class=s2 >"right_only"</span><span class=p >)</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >combined</span><span class=o >.</span><span class=n >sample</span><span class=p >()</span><span class=o >.</span><span class=n >T</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>163509 <tr> <th>Credit Score <td>711 <tr> <th>First Payment Date <td>200404 <tr> <th>First Time Homebuyer Flag <td>N <tr> <th>Maturity Date <td>201903 <tr> <th>Metropolitan Statistical Area (MSA) Or Metropolitan Division <td>NaN <tr> <th>Mortgage Insurance Percentage (MI %) <td>0 <tr> <th>Number of Units <td>1 <tr> <th>Occupancy Status <td>P <tr> <th>Original Combined Loan-to-Value (CLTV) <td>67 <tr> <th>Original Debt-to-Income (DTI) Ratio <td>21 <tr> <th>Original UPB <td>93000 <tr> <th>Original Loan-to-Value (LTV) <td>67 <tr> <th>Original Interest Rate <td>5.375 <tr> <th>Channel <td>T <tr> <th>Prepayment Penalty Mortgage (PPM) Flag <td>N <tr> <th>Amortization Type (Formerly Product Type) <td>FRM <tr> <th>Property State <td>MO <tr> <th>Property Type <td>SF <tr> <th>Postal Code <td>63300 <tr> <th>Loan Sequence Number <td>F04Q10238951 <tr> <th>Loan Purpose <td>N <tr> <th>Original Loan Term <td>180 <tr> <th>Number of Borrowers <td>2 <tr> <th>Seller Name <td>ABN AMRO MORTGAGE GROUP, INC. <tr> <th>Servicer Name <td>CITIMORTGAGE, INC. <tr> <th>Super Conforming Flag <td>NaN <tr> <th>Pre-HARP Loan Sequence Number <td>NaN <tr> <th>Program Indicator <td>9 <tr> <th>HARP Indicator <td>NaN <tr> <th>Property Valuation Method <td>9 <tr> <th>Interest Only (I/O) Indicator <td>N <tr> <th>Mortgage Insurance Cancellation Indicator <td>9 <tr> <th>Monthly Reporting Period <td>200509 <tr> <th>Current Loan Delinquency Status <td>0 <tr> <th>_merge <td>both </table> </div></div> </div> </section> <section id=Exercise-4 > <h3 id=Exercise-4 >Exercise 4<a class=headerlink  href="#Exercise-4" title="Link to this heading">¶</a></h3> <p>Mortgages come in many shapes and flavors, however your servicer is only interested in predicting default for the more standard form of mortgage. Subset your data to only include:</p> <ul class=simple > <li><p>Mortgages taken out for purchase of a property,</p> <li><p>With first payments due in the quarter of origination or the first quarter after origination.</p> </ul> <p>(In a perfect world we would just limit our analysis to mortgages where the first payment is due the month after origination. Unfortunately we only know the <em>quarter</em> of origination, so the only way to subset for relatively vanilla mortgages is to look for mortgages where the first payment was due in the same quarter or the quarter after origination.)</p> <p>Subset for these mortgages. How many unique mortgages remain in the data?</p> <p>Hint: You may need to read the documentation for the <code class="docutils literal notranslate"><span class=pre >Loan</span> <span class=pre >Sequence</span> <span class=pre >Number</span></code> variable.</p> <p>Store the resulting number of unique mortgages in <code class="docutils literal notranslate"><span class=pre >results</span></code> under the key <code class="docutils literal notranslate"><span class=pre >ex4_num_mortgages</span></code>.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[9]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># For purchase</span>
<span class=n >combined</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"Loan Purpose"</span><span class=p >]</span> <span class=o >==</span> <span class=s2 >"P"</span><span class=p >]</span>

<span class=c1 ># First payment</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"First Payment Date"</span><span class=p >]</span> <span class=o >//</span> <span class=mi >100</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"month_first"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"First Payment Date"</span><span class=p >]</span> <span class=o >%</span> <span class=mi >100</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >=</span> <span class=p >((</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"month_first"</span><span class=p >]</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >//</span> <span class=mi >3</span><span class=p >)</span> <span class=o >+</span> <span class=mi >1</span>
<span class=k >assert</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span><span class=o >.</span><span class=n >isin</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=mi >5</span><span class=p >))</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>

<span class=n >combined</span><span class=p >[</span><span class=s2 >"year_decimal_first"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >+</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"month_first"</span><span class=p >]</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >/</span> <span class=mi >12</span>
<span class=p >)</span>

<span class=c1 ># Origination. Get from loan sequence number.</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >str</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=mi >2</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span> <span class=o >+</span> <span class=mi >2000</span>
<span class=k >assert</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >2004</span><span class=p >)</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >str</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=mi >4</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
<span class=k >assert</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span><span class=o >.</span><span class=n >isin</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=mi >5</span><span class=p >))</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>


<span class=c1 ># Keep only if same or following quarter</span>
<span class=n >same_quarter</span> <span class=o >=</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >==</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >])</span> <span class=o >&amp;</span> <span class=p >(</span>
    <span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >==</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span>
<span class=p >)</span>
<span class=n >next_quarter_same_year</span> <span class=o >=</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >==</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >])</span> <span class=o >&amp;</span> <span class=p >(</span>
    <span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >==</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span> <span class=o >+</span> <span class=mi >1</span><span class=p >)</span>
<span class=p >)</span>
<span class=n >next_quarter_next_year</span> <span class=o >=</span> <span class=p >(</span>
    <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >==</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span> <span class=o >+</span> <span class=mi >1</span><span class=p >))</span>
    <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >)</span>
    <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >4</span><span class=p >)</span>
<span class=p >)</span>
<span class=n >combined</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=n >same_quarter</span> <span class=o >|</span> <span class=n >next_quarter_same_year</span> <span class=o >|</span> <span class=n >next_quarter_next_year</span><span class=p >]</span>

<span class=n >results</span><span class=p >[</span><span class=s2 >"ex4_num_mortgages"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >nunique</span><span class=p >()</span>
<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"After subsetting there are </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex4_num_mortgages'</span><span class=p >]</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > unique mortgages"</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
After subsetting there are 17,504 unique mortgages
</pre></div></div> </div> </section> <section id=Exercise-5 > <h3 id=Exercise-5 >Exercise 5<a class=headerlink  href="#Exercise-5" title="Link to this heading">¶</a></h3> <p>The servicer wants to predict delinquency during the first 24 payment due dates (you may assume payments are due every month starting with the month the first payment is due). Subset the data to these first 24 (possible) payment due dates.</p> <p>Note that not all loans will have 24 records in the servicing file in the first 24 months as a result of data merging issues on behalf of Freddie Mac. As noted in the Freddie Mac documentation:</p> <blockquote> <div><p>For a given loan, each monthly reporting period in the monthly performance data file combines data elements from multiple reporting cycles and systems at Freddie Mac. As such, perceived data anomalies may be a result of timing mismatches between default/delinquency reporting cycles and investor reporting cycles. Examples of some commonly occurring anomalies in the data are included throughout this section. In all cases, the best information available at the time the Dataset is generated, subject to operational constraints, is used.</p> </div></blockquote> <p>So subset for the first two years of (possible) payments, resulting in <em>up to</em> 24 observations per mortgage (but potentially less given the data cleanliness issues).</p> <p>After this subsetting, store the number of remaining observations (not mortgages, observation) in <code class="docutils literal notranslate"><span class=pre >results</span></code> under the key <code class="docutils literal notranslate"><span class=pre >"ex5_num_obs"</span></code>.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_reporting"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"Monthly Reporting Period"</span><span class=p >]</span> <span class=o >//</span> <span class=mi >100</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"month_reporting"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"Monthly Reporting Period"</span><span class=p >]</span> <span class=o >%</span> <span class=mi >100</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"year_decimal_reporting"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined</span><span class=p >[</span><span class=s2 >"year_reporting"</span><span class=p >]</span> <span class=o >+</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"month_reporting"</span><span class=p >]</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >/</span> <span class=mi >12</span>
<span class=p >)</span>

<span class=n >combined</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >round</span><span class=p >(</span>
    <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"year_decimal_reporting"</span><span class=p >]</span> <span class=o >-</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"year_decimal_first"</span><span class=p >]),</span> <span class=mi >4</span>
<span class=p >)</span>
<span class=n >combined</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span><span class=o >.</span><span class=n >value_counts</span><span class=p >()</span><span class=o >.</span><span class=n >sort_index</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
age
-0.0833    14436
 0.0000    16613
 0.0833    16970
 0.1667    17088
 0.2500    17051
 0.3333    16975
 0.4167    16899
 0.5000    16788
 0.5833    16629
 0.6667    16494
 0.7500    16342
 0.8333    16203
 0.9167    16038
 1.0000    15861
 1.0833    15683
 1.1667    15535
 1.2500    15370
 1.3333    15192
 1.4167    15052
 1.5000    14940
 1.5833    14823
 1.6667    14704
 1.7500    14586
 1.8333    14466
 1.9167    13159
 2.0000    11743
 2.0833    10369
 2.1667     8766
 2.2500     7129
 2.3333     5561
 2.4167     4474
 2.5000     3416
 2.5833     2342
 2.6667     1397
 2.7500      600
 2.8333       16
Name: count, dtype: int64
</pre></div></div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >two_years</span> <span class=o >=</span> <span class=n >combined</span><span class=p >[(</span><span class=mi >0</span> <span class=o >&lt;=</span> <span class=n >combined</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >])</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span> <span class=o >&lt;</span> <span class=mi >2</span><span class=p >)]</span>

<span class=c1 ># Make sure I don't have an off-by-one problem.</span>
<span class=k >assert</span> <span class=nb >len</span><span class=p >(</span><span class=n >two_years</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span><span class=o >.</span><span class=n >value_counts</span><span class=p >())</span> <span class=o >==</span> <span class=mi >24</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >results</span><span class=p >[</span><span class=s2 >"ex5_num_obs"</span><span class=p >]</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >two_years</span><span class=p >)</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"Number of obs is </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex5_num_obs'</span><span class=p >]</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 >"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Number of obs is 379,461
</pre></div></div> </div> </section> <section id=Exercise-6 > <h3 id=Exercise-6 >Exercise 6<a class=headerlink  href="#Exercise-6" title="Link to this heading">¶</a></h3> <p>For each unique mortgage in your dataset, create an indicator variable that takes on a value of 1 if, at any time during this period, the mortgage has been delinquent.</p> <p>Delinquency status is stored in the variable <code class="docutils literal notranslate"><span class=pre >CURRENT</span> <span class=pre >LOAN</span> <span class=pre >DELINQUENCY</span> <span class=pre >STATUS</span></code>, and is coded as:</p> <blockquote> <div><p>CURRENT LOAN DELINQUENCY STATUS – A value corresponding to the number of days the borrower is delinquent, based on the due date of last paid installment (“DDLPI”) reported by servicers to Freddie Mac, and is calculated under the Mortgage Bankers Association (MBA) method. If a loan has been acquired by REO, then the Current Loan Delinquency Status will reflect the value corresponding to that status (instead of the value corresponding to the number of days the borrower is delinquent).</p> <p>0 = Current, or less than 30 days delinquent</p> <p>1 = 30-59 days delinquent</p> <p>2=60–89days delinquent</p> <p>3=90–119days delinquent</p> <p>And so on…</p> <p>RA = REO Acquisition</p> </div></blockquote> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[13]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Current Loan Delinquency Status</span>
<span class=n >two_years</span><span class=p >[</span><span class=s2 >"Current Loan Delinquency Status"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >two_years</span><span class=p >[</span><span class=s2 >"Current Loan Delinquency Status"</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"RA"</span><span class=p >,</span> <span class=mi >99</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
<span class=p >)</span>

<span class=n >two_years</span><span class=p >[</span><span class=s2 >"ever_delinquent"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >two_years</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=s2 >"Loan Sequence Number"</span><span class=p >)[</span>
        <span class=s2 >"Current Loan Delinquency Status"</span>
    <span class=p >]</span><span class=o >.</span><span class=n >transform</span><span class=p >(</span><span class=s2 >"max"</span><span class=p >)</span>
    <span class=o >&gt;</span> <span class=mi >0</span>
<span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
</pre></div> </div> </div> </section> <section id=Exercise-7 > <h3 id=Exercise-7 >Exercise 7<a class=headerlink  href="#Exercise-7" title="Link to this heading">¶</a></h3> <p>At this point, you should be able to drop all servicing variables reported on a monthly basis and just keep information about the original mortgage issuance (and still keep an indicator for whether the mortgage has ever been delinquent).</p> <p>Store the final number of mortgages in your data under <code class="docutils literal notranslate"><span class=pre >ex7_num_mortgages</span></code> and the share (between 0 and 1) of mortgages that have been delinquent under <code class="docutils literal notranslate"><span class=pre >ex7_share_delinquent</span></code>.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[14]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >two_years</span><span class=o >.</span><span class=n >columns</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[14]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Index(['Credit Score', 'First Payment Date', 'First Time Homebuyer Flag',
       'Maturity Date',
       'Metropolitan Statistical Area (MSA) Or Metropolitan Division',
       'Mortgage Insurance Percentage (MI %)', 'Number of Units',
       'Occupancy Status', 'Original Combined Loan-to-Value (CLTV)',
       'Original Debt-to-Income (DTI) Ratio', 'Original UPB',
       'Original Loan-to-Value (LTV)', 'Original Interest Rate', 'Channel',
       'Prepayment Penalty Mortgage (PPM) Flag',
       'Amortization Type (Formerly Product Type)', 'Property State',
       'Property Type', 'Postal Code', 'Loan Sequence Number', 'Loan Purpose',
       'Original Loan Term', 'Number of Borrowers', 'Seller Name',
       'Servicer Name', 'Super Conforming Flag',
       'Pre-HARP Loan Sequence Number', 'Program Indicator', 'HARP Indicator',
       'Property Valuation Method', 'Interest Only (I/O) Indicator',
       'Mortgage Insurance Cancellation Indicator', 'Monthly Reporting Period',
       'Current Loan Delinquency Status', '_merge', 'year_first',
       'month_first', 'quarter_first', 'year_decimal_first', 'year_orig',
       'quarter_orig', 'year_reporting', 'month_reporting',
       'year_decimal_reporting', 'age', 'ever_delinquent'],
      dtype='object')
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[15]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># This is made easier by drops earlier.</span>
<span class=n >two_years</span> <span class=o >=</span> <span class=n >two_years</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span>
    <span class=n >columns</span><span class=o >=</span><span class=p >[</span>
        <span class=s2 >"Current Loan Delinquency Status"</span><span class=p >,</span>
        <span class=s2 >"Monthly Reporting Period"</span><span class=p >,</span>
        <span class=s2 >"month_reporting"</span><span class=p >,</span>
        <span class=s2 >"year_reporting"</span><span class=p >,</span>
        <span class=s2 >"year_decimal_reporting"</span><span class=p >,</span>
        <span class=s2 >"age"</span><span class=p >,</span>
        <span class=s2 >"_merge"</span><span class=p >,</span>
    <span class=p >]</span>
<span class=p >)</span>
<span class=n >two_years</span> <span class=o >=</span> <span class=n >two_years</span><span class=o >.</span><span class=n >drop_duplicates</span><span class=p >()</span>
<span class=k >assert</span> <span class=n >two_years</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >is_unique</span>
<span class=n >results</span><span class=p >[</span><span class=s2 >"ex7_share_delinquent"</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=o >.</span><span class=n >ever_delinquent</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
<span class=n >results</span><span class=p >[</span><span class=s2 >"ex7_num_mortgages"</span><span class=p >]</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >two_years</span><span class=p >)</span>

<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"There are now </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex7_num_mortgages'</span><span class=p >]</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > unique mortgages in the data."</span>
<span class=p >)</span>
<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"During the period studied, </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex7_share_delinquent'</span><span class=p >]</span><span class=si >:</span><span class=s2 >.1%</span><span class=si >}</span><span class=s2 >"</span>
    <span class=s2 >" of loans are delinquent at some point."</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
There are now 17,471 unique mortgages in the data.
During the period studied, 7.1% of loans are delinquent at some point.
</pre></div></div> </div> </section> </section> <section id=Modelling-Delinquency-Risk > <h2 id=Modelling-Delinquency-Risk >Modelling Delinquency Risk<a class=headerlink  href="#Modelling-Delinquency-Risk" title="Link to this heading">¶</a></h2> <p>Your data should now be relatively <a class="reference external" href="https://vita.had.co.nz/papers/tidy-data.pdf">tidy</a>, in the technical sense of the term. And that means it should be relatively straightforward for you to build a model that answers the question “Given the features of a newly originated mortgage, how likely is the mortgage holder to fall into delinquency within the first two years after origination?”</p> <section id=Exercise-8 > <h3 id=Exercise-8 >Exercise 8<a class=headerlink  href="#Exercise-8" title="Link to this heading">¶</a></h3> <p>First, we need to identify the target for our model useful predictors from the data and do feature engineering.</p> <p>Let’s begin with identifying some features that probably <em>aren’t</em> going to be useful. For example, <code class="docutils literal notranslate"><span class=pre >"Metropolitan</span> <span class=pre >Statistical</span> <span class=pre >Area</span> <span class=pre >(MSA)</span> <span class=pre >Or</span> <span class=pre >Metropolitan</span> <span class=pre >Division"</span></code> is probably <em>not</em> an appropriate feature to include in this analysis. Can you figure out why? Make sure to show (quantitatively) why not.</p> <p>Hint: should be more than the missing rate.</p> <p>Hint 2: how many observations for a given city do you think you’d need to determine if that city had especially high mortgage delinquency rates?</p> <p>Hint 3: if not all possible values of a variable are present in your training data, what problem might that cause during testing and deployment?</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[16]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >missing</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >two_years</span><span class=p >[</span><span class=s2 >"Metropolitan Statistical Area (MSA) Or Metropolitan Division"</span><span class=p >]</span>
    <span class=o >.</span><span class=n >isna</span><span class=p >()</span>
    <span class=o >.</span><span class=n >mean</span><span class=p >()</span>
<span class=p >)</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"MSA Missing for </span><span class=si >{</span><span class=n >missing</span><span class=si >:</span><span class=s2 >.1%</span><span class=si >}</span><span class=s2 > of observations."</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
MSA Missing for 27.6% of observations.
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[17]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >has_msa</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span>
    <span class=n >two_years</span><span class=p >[</span><span class=s2 >"Metropolitan Statistical Area (MSA) Or Metropolitan Division"</span><span class=p >]</span><span class=o >.</span><span class=n >notnull</span><span class=p >()</span>
<span class=p >]</span>
<span class=n >has_msa</span><span class=p >[</span><span class=s2 >"msa_has_delinquent"</span><span class=p >]</span> <span class=o >=</span> <span class=n >has_msa</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span>
    <span class=s2 >"Metropolitan Statistical Area (MSA) Or Metropolitan Division"</span>
<span class=p >)[</span><span class=s2 >"ever_delinquent"</span><span class=p >]</span><span class=o >.</span><span class=n >transform</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >sum</span><span class=p >)</span>

<span class=n >no_delinquents</span> <span class=o >=</span> <span class=p >(</span><span class=n >has_msa</span><span class=p >[</span><span class=s2 >"msa_has_delinquent"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
<span class=n >few_delinquents</span> <span class=o >=</span> <span class=p >(</span><span class=n >has_msa</span><span class=p >[</span><span class=s2 >"msa_has_delinquent"</span><span class=p >]</span> <span class=o >&lt;</span> <span class=mi >4</span><span class=p >)</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>

<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"Another </span><span class=si >{</span><span class=n >no_delinquents</span><span class=si >:</span><span class=s2 >.1%</span><span class=si >}</span><span class=s2 > of observations in MSA with zero delinquencies "</span>
    <span class=sa >f</span><span class=s2 >"and </span><span class=si >{</span><span class=n >few_delinquents</span><span class=si >:</span><span class=s2 >.1%</span><span class=si >}</span><span class=s2 > have less than 4 delinquencies."</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Another 10.0% of observations in MSA with zero delinquencies and 39.1% have less than 4 delinquencies.
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/fs/h_8_rwsn5hvg9mhp0txgc_s9v6191b/T/ipykernel_20548/2479956568.py:6: FutureWarning: The provided callable &lt;function sum at 0x104c5a480&gt; is currently using SeriesGroupBy.sum. In a future version of pandas, the provided callable will be used directly. To keep current behavior pass the string "sum" instead.
  )["ever_delinquent"].transform(np.sum)
</pre></div></div> </div> <blockquote> <div><p>It’s missing for about 27% of the mortgages in the data, there are zero delinquencies in another 10% of observations, and 39% have 3 or fewer. That’s just too sparse — when coefficients are being estimated for those categories, they’re bound to over-fit.</p> <p>Put differently: would you be comfortable estimating the delinquency rate for, say, the city of Denver, CO with three or fewer observations? Of course not, but when you try and predict values to new data, that’s precisely what you’re doing — applying an estimate of delinquency from a few observations to any new observations in that MSA.</p> </div></blockquote> </section> <section id=Exercise-9 > <h3 id=Exercise-9 >Exercise 9<a class=headerlink  href="#Exercise-9" title="Link to this heading">¶</a></h3> <p>For your analysis, include the following variables:</p> <div class="highlight-none notranslate"><div class=highlight ><pre><span></span>Credit Score
First Time Homebuyer Flag
Number of Units
Mortgage Insurance Percentage (MI %)
Occupancy Status
Original Debt-to-Income (DTI) Ratio
Original UPB
Original Loan-to-Value (LTV)
Original Interest Rate
Channel
Prepayment Penalty Mortgage (PPM) Flag
Amortization Type (Formerly Product Type)
Property State
Property Type
Original Loan Term
Number of Borrowers
Interest Only (I/O) Indicator
</pre></div> </div> <p>Be sure to clean these variables. When doing so, please treat missing data as missing (e.g., <code class="docutils literal notranslate"><span class=pre >np.nan</span></code>, not as a distinct category).</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[18]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Clean up!</span>
<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=p >[</span>
    <span class=s2 >"Channel"</span><span class=p >,</span>
    <span class=s2 >"Property Valuation Method"</span><span class=p >,</span>
    <span class=s2 >"First Time Homebuyer Flag"</span><span class=p >,</span>
    <span class=s2 >"Occupancy Status"</span><span class=p >,</span>
<span class=p >]:</span>
    <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >9</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
    <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"9"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>

<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=p >[</span><span class=s2 >"Number of Units"</span><span class=p >,</span> <span class=s2 >"Property Type"</span><span class=p >,</span> <span class=s2 >"Number of Borrowers"</span><span class=p >]:</span>
    <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >99</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
    <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"99"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>


<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=p >[</span>
    <span class=s2 >"Mortgage Insurance Percentage (MI %)"</span><span class=p >,</span>
    <span class=s2 >"Original Debt-to-Income (DTI) Ratio"</span><span class=p >,</span>
    <span class=s2 >"Original Loan-to-Value (LTV)"</span><span class=p >,</span>
<span class=p >]:</span>
    <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >999</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
    <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"999"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>

<span class=n >two_years</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >9999</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
<span class=n >two_years</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"9999"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[19]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >for_ml</span> <span class=o >=</span> <span class=n >two_years</span><span class=p >[</span>
    <span class=p >[</span>
        <span class=s2 >"Credit Score"</span><span class=p >,</span>
        <span class=s2 >"First Time Homebuyer Flag"</span><span class=p >,</span>
        <span class=s2 >"Number of Units"</span><span class=p >,</span>
        <span class=s2 >"Mortgage Insurance Percentage (MI %)"</span><span class=p >,</span>
        <span class=s2 >"Occupancy Status"</span><span class=p >,</span>
        <span class=s2 >"Original Debt-to-Income (DTI) Ratio"</span><span class=p >,</span>
        <span class=s2 >"Original UPB"</span><span class=p >,</span>
        <span class=s2 >"Original Loan-to-Value (LTV)"</span><span class=p >,</span>
        <span class=s2 >"Original Interest Rate"</span><span class=p >,</span>
        <span class=s2 >"Channel"</span><span class=p >,</span>
        <span class=s2 >"Prepayment Penalty Mortgage (PPM) Flag"</span><span class=p >,</span>
        <span class=s2 >"Amortization Type (Formerly Product Type)"</span><span class=p >,</span>
        <span class=s2 >"Property State"</span><span class=p >,</span>
        <span class=s2 >"Property Type"</span><span class=p >,</span>
        <span class=s2 >"Original Loan Term"</span><span class=p >,</span>
        <span class=s2 >"Number of Borrowers"</span><span class=p >,</span>
        <span class=s2 >"Interest Only (I/O) Indicator"</span><span class=p >,</span>
        <span class=s2 >"ever_delinquent"</span><span class=p >,</span>
        <span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=p >]</span>
<span class=p >]</span>
</pre></div> </div> </div> </section> <section id=Exercise-10 > <h3 id=Exercise-10 >Exercise 10<a class=headerlink  href="#Exercise-10" title="Link to this heading">¶</a></h3> <p>The next step in our analysis is to convert our categorical variables to one-hot-encodings and use <code class="docutils literal notranslate"><span class=pre >train_test_split</span></code> to split our data.</p> <p>To ensure replicability, <strong>before</strong> you <code class="docutils literal notranslate"><span class=pre >train_test_split</span></code> your data, please sort your data by <code class="docutils literal notranslate"><span class=pre >Loan</span> <span class=pre >Sequence</span> <span class=pre >Number</span></code>. This will ensure when we split the data with a random seed below, everyone will get the same split and the autograder will function.</p> <p>You may create your one-hot-encodings however you wish, but I’m a fan of the <a class="reference external" href="https://patsy.readthedocs.io/en/latest/overview.html">patsy library’s</a> <code class="docutils literal notranslate"><span class=pre >dmatrices</span></code> function.</p> <p>Hint: You should end up with 8 categorical variables, including some binary flags and <code class="docutils literal notranslate"><span class=pre >Number_of_Borrowers</span></code>, <code class="docutils literal notranslate"><span class=pre >Number_of_Units</span></code> (which you could argue should be continuous, but I think are better treated as categorical).</p> <p>Store the number of observations in your final dataset in <code class="docutils literal notranslate"><span class=pre >ex10_num_obs</span></code>.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[20]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >for_ml</span> <span class=o >=</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >sort_values</span><span class=p >(</span><span class=s2 >"Loan Sequence Number"</span><span class=p >)</span>

<span class=kn >import</span> <span class=nn >patsy</span>
<span class=kn >import</span> <span class=nn >re</span>

<span class=c1 ># Patsy can't handle this type of punctuation in formulas</span>
<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >" "</span><span class=p >,</span> <span class=s2 >"_"</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"%"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"/"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"\("</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"\)"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"-"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>

<span class=n >for_ml</span><span class=o >.</span><span class=n >columns</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[20]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Index(['Credit_Score', 'First_Time_Homebuyer_Flag', 'Number_of_Units',
       'Mortgage_Insurance_Percentage_MI_', 'Occupancy_Status',
       'Original_DebttoIncome_DTI_Ratio', 'Original_UPB',
       'Original_LoantoValue_LTV', 'Original_Interest_Rate', 'Channel',
       'Prepayment_Penalty_Mortgage_PPM_Flag',
       'Amortization_Type_Formerly_Product_Type', 'Property_State',
       'Property_Type', 'Original_Loan_Term', 'Number_of_Borrowers',
       'Interest_Only_IO_Indicator', 'ever_delinquent',
       'Loan_Sequence_Number'],
      dtype='object')
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[21]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >for_ml</span><span class=p >[</span><span class=s2 >"Property_Type"</span><span class=p >]</span><span class=o >.</span><span class=n >value_counts</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[21]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Property_Type
SF    12117
PU     3224
CO     1741
MH      264
CP      120
Name: count, dtype: int64
</pre></div></div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[22]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >y</span><span class=p >,</span> <span class=n >X</span> <span class=o >=</span> <span class=n >patsy</span><span class=o >.</span><span class=n >dmatrices</span><span class=p >(</span>
    <span class=s2 >"ever_delinquent ~ Credit_Score"</span>
    <span class=s2 >"+ First_Time_Homebuyer_Flag"</span>
    <span class=s2 >"+ C(Number_of_Units)"</span>
    <span class=s2 >"+ Mortgage_Insurance_Percentage_MI_"</span>
    <span class=s2 >"+ Occupancy_Status"</span>
    <span class=s2 >"+ Original_DebttoIncome_DTI_Ratio"</span>
    <span class=s2 >"+ Original_UPB"</span>
    <span class=s2 >"+ Original_LoantoValue_LTV"</span>
    <span class=s2 >"+ Original_Interest_Rate"</span>
    <span class=s2 >"+ Channel"</span>
    <span class=s2 >"+ Prepayment_Penalty_Mortgage_PPM_Flag"</span>
    <span class=s2 >"+ Amortization_Type_Formerly_Product_Type"</span>
    <span class=s2 >"+ Property_State"</span>
    <span class=s2 >"+ Property_Type"</span>
    <span class=s2 >"+ Original_Loan_Term"</span>
    <span class=s2 >"+ C(Number_of_Borrowers)"</span>
    <span class=s2 >"+ Interest_Only_IO_Indicator"</span><span class=p >,</span>
    <span class=n >for_ml</span><span class=p >,</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[23]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Eyeball check result</span>
<span class=n >X</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[23]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
DesignMatrix with shape (17052, 76)
  Columns:
    ['Intercept',
     'First_Time_Homebuyer_Flag[T.Y]',
     'C(Number_of_Units)[T.2.0]',
     'C(Number_of_Units)[T.3.0]',
     'C(Number_of_Units)[T.4.0]',
     'Occupancy_Status[T.P]',
     'Occupancy_Status[T.S]',
     'Channel[T.C]',
     'Channel[T.R]',
     'Channel[T.T]',
     'Prepayment_Penalty_Mortgage_PPM_Flag[T.Y]',
     'Property_State[T.AL]',
     'Property_State[T.AR]',
     'Property_State[T.AZ]',
     'Property_State[T.CA]',
     'Property_State[T.CO]',
     'Property_State[T.CT]',
     'Property_State[T.DC]',
     'Property_State[T.DE]',
     'Property_State[T.FL]',
     'Property_State[T.GA]',
     'Property_State[T.GU]',
     'Property_State[T.HI]',
     'Property_State[T.IA]',
     'Property_State[T.ID]',
     'Property_State[T.IL]',
     'Property_State[T.IN]',
     'Property_State[T.KS]',
     'Property_State[T.KY]',
     'Property_State[T.LA]',
     'Property_State[T.MA]',
     'Property_State[T.MD]',
     'Property_State[T.ME]',
     'Property_State[T.MI]',
     'Property_State[T.MN]',
     'Property_State[T.MO]',
     'Property_State[T.MS]',
     'Property_State[T.MT]',
     'Property_State[T.NC]',
     'Property_State[T.ND]',
     'Property_State[T.NE]',
     'Property_State[T.NH]',
     'Property_State[T.NJ]',
     'Property_State[T.NM]',
     'Property_State[T.NV]',
     'Property_State[T.NY]',
     'Property_State[T.OH]',
     'Property_State[T.OK]',
     'Property_State[T.OR]',
     'Property_State[T.PA]',
     'Property_State[T.PR]',
     'Property_State[T.RI]',
     'Property_State[T.SC]',
     'Property_State[T.SD]',
     'Property_State[T.TN]',
     'Property_State[T.TX]',
     'Property_State[T.UT]',
     'Property_State[T.VA]',
     'Property_State[T.VI]',
     'Property_State[T.VT]',
     'Property_State[T.WA]',
     'Property_State[T.WI]',
     'Property_State[T.WV]',
     'Property_State[T.WY]',
     'Property_Type[T.CP]',
     'Property_Type[T.MH]',
     'Property_Type[T.PU]',
     'Property_Type[T.SF]',
     'C(Number_of_Borrowers)[T.2.0]',
     'Credit_Score',
     'Mortgage_Insurance_Percentage_MI_',
     'Original_DebttoIncome_DTI_Ratio',
     'Original_UPB',
     'Original_LoantoValue_LTV',
     'Original_Interest_Rate',
     'Original_Loan_Term']
  Terms:
    'Intercept' (column 0)
    'First_Time_Homebuyer_Flag' (column 1)
    'C(Number_of_Units)' (columns 2:5)
    'Occupancy_Status' (columns 5:7)
    'Channel' (columns 7:10)
    'Prepayment_Penalty_Mortgage_PPM_Flag' (column 10)
    'Amortization_Type_Formerly_Product_Type' (columns 11:11)
    'Property_State' (columns 11:64)
    'Property_Type' (columns 64:68)
    'C(Number_of_Borrowers)' (column 68)
    'Interest_Only_IO_Indicator' (columns 69:69)
    'Credit_Score' (column 69)
    'Mortgage_Insurance_Percentage_MI_' (column 70)
    'Original_DebttoIncome_DTI_Ratio' (column 71)
    'Original_UPB' (column 72)
    'Original_LoantoValue_LTV' (column 73)
    'Original_Interest_Rate' (column 74)
    'Original_Loan_Term' (column 75)
  (to view full data, use np.asarray(this_obj))
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[24]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >results</span><span class=p >[</span><span class=s2 >"ex10_num_obs"</span><span class=p >]</span> <span class=o >=</span> <span class=n >X</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"The final dataset has </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex10_num_obs'</span><span class=p >]</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > observations"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
The final dataset has 17,052 observations
</pre></div></div> </div> </section> <section id=Exercise-11 > <h3 id=Exercise-11 >Exercise 11<a class=headerlink  href="#Exercise-11" title="Link to this heading">¶</a></h3> <p>Use <code class="docutils literal notranslate"><span class=pre >train_test_split</span></code> from <code class="docutils literal notranslate"><span class=pre >sklearn.model_selection</span></code> to split the data.</p> <p>Before you do, Use <code class="docutils literal notranslate"><span class=pre >0.2</span></code> as the <code class="docutils literal notranslate"><span class=pre >test_size</span></code> and use <code class="docutils literal notranslate"><span class=pre >random_state=42</span></code>.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[25]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >from</span> <span class=nn >sklearn.model_selection</span> <span class=kn >import</span> <span class=n >train_test_split</span>

<span class=n >X_train</span><span class=p >,</span> <span class=n >X_test</span><span class=p >,</span> <span class=n >y_train</span><span class=p >,</span> <span class=n >y_test</span> <span class=o >=</span> <span class=n >train_test_split</span><span class=p >(</span>
    <span class=n >X</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >test_size</span><span class=o >=</span><span class=mf >0.2</span><span class=p >,</span> <span class=n >random_state</span><span class=o >=</span><span class=mi >42</span>
<span class=p >)</span>
</pre></div> </div> </div> </section> <section id=Exercise-12 > <h3 id=Exercise-12 >Exercise 12<a class=headerlink  href="#Exercise-12" title="Link to this heading">¶</a></h3> <p>Now fit a <code class="docutils literal notranslate"><span class=pre >GradientBoostingClassifier</span></code> to the data (from <code class="docutils literal notranslate"><span class=pre >sklearn.ensemble</span></code>). Set <code class="docutils literal notranslate"><span class=pre >random_state=42</span></code>. using <code class="docutils literal notranslate"><span class=pre >roc_auc_score</span></code>, get your ROC AUC score against the test data.</p> <p><strong>Please round your answer to two decimal places</strong> - sometimes sklearn models have very small instabilities even after setting a random seed.</p> <p>Store in <code class="docutils literal notranslate"><span class=pre >results</span></code> under the key <code class="docutils literal notranslate"><span class=pre >"ex12_roc_auc"</span></code>.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[26]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >from</span> <span class=nn >sklearn.ensemble</span> <span class=kn >import</span> <span class=n >GradientBoostingClassifier</span>
<span class=kn >from</span> <span class=nn >sklearn.metrics</span> <span class=kn >import</span> <span class=n >roc_auc_score</span><span class=p >,</span> <span class=n >confusion_matrix</span>
<span class=kn >import</span> <span class=nn >matplotlib.pyplot</span> <span class=k >as</span> <span class=nn >plt</span>


<span class=n >gb</span> <span class=o >=</span> <span class=n >GradientBoostingClassifier</span><span class=p >(</span><span class=n >random_state</span><span class=o >=</span><span class=mi >42</span><span class=p >)</span>
<span class=n >gb</span><span class=o >.</span><span class=n >fit</span><span class=p >(</span><span class=n >X_train</span><span class=p >,</span> <span class=n >y_train</span><span class=p >)</span>

<span class=c1 ># Predicts</span>
<span class=n >y_pred</span> <span class=o >=</span> <span class=n >gb</span><span class=o >.</span><span class=n >predict</span><span class=p >(</span><span class=n >X_test</span><span class=p >)</span>
<span class=n >y_pred_proba</span> <span class=o >=</span> <span class=n >gb</span><span class=o >.</span><span class=n >predict_proba</span><span class=p >(</span><span class=n >X_test</span><span class=p >)[:,</span> <span class=mi >1</span><span class=p >]</span>

<span class=c1 ># Score ane matrix</span>
<span class=n >auc_score</span> <span class=o >=</span> <span class=n >roc_auc_score</span><span class=p >(</span><span class=n >y_test</span><span class=p >,</span> <span class=n >y_pred_proba</span><span class=p >)</span>
<span class=n >conf_matrix</span> <span class=o >=</span> <span class=n >confusion_matrix</span><span class=p >(</span><span class=n >y_test</span><span class=p >,</span> <span class=n >y_pred</span><span class=p >)</span>

<span class=n >results</span><span class=p >[</span><span class=s2 >"ex12_roc_auc"</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >round</span><span class=p >(</span><span class=n >auc_score</span><span class=p >,</span> <span class=mi >2</span><span class=p >)</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"My ROC AUC score rounded to 2 places is </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex12_roc_auc'</span><span class=p >]</span><span class=si >:</span><span class=s2 >.2f</span><span class=si >}</span><span class=s2 >"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/Users/nce8/opt/miniconda3/lib/python3.11/site-packages/sklearn/preprocessing/_label.py:114: DataConversionWarning: A column-vector y was passed when a 1d array was expected. Please change the shape of y to (n_samples, ), for example using ravel().
  y = column_or_1d(y, warn=True)
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
My ROC AUC score rounded to 2 places is 0.71
</pre></div></div> </div> </section> <section id=Exercise-13 > <h3 id=Exercise-13 >Exercise 13<a class=headerlink  href="#Exercise-13" title="Link to this heading">¶</a></h3> <p>Use the <code class="docutils literal notranslate"><span class=pre >predict</span></code> method to generate a confusion matrix. What problem do you see with the result?</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[27]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"Confusion matrix:</span><span class=se >\n</span><span class=si >{</span><span class=n >conf_matrix</span><span class=si >}</span><span class=s2 >"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Confusion matrix:
[[3146    9]
 [ 252    4]]
</pre></div></div> </div> <blockquote> <div><p>It’s just getting accuracy by almost always saying “no delinquency” (the dominant class), a canonical issue with unbalanced data.</p> </div></blockquote> </section> <section id=Exercise-14 > <h3 id=Exercise-14 >Exercise 14<a class=headerlink  href="#Exercise-14" title="Link to this heading">¶</a></h3> <p>To address the problem from Exercise 13, use <code class="docutils literal notranslate"><span class=pre >.predict_proba()</span></code> to set your own threshold for classification. Your stakeholder is mostly concerned with False Negatives (mortgages classified as safe that actually are not), so use an 8% probability threshold to get a good balance of a low <a class="reference external" href="https://en.wikipedia.org/wiki/False_omission_rate">False Omission Rate</a> (the share of predicted negatives that are false negatives) with a reasonable amount of mortgages still being considered “viable.”</p> <p>In other words, treat a mortgage as risky (<code class="docutils literal notranslate"><span class=pre >1</span></code>) if the predicted probability is greater than 0.08. Be sure to use “greater than” rather than “greater than or equal to”.</p> <p>What is the False Omission Rate at an 8% classification threshold from the model above?</p> <p>Store the result under the key <code class="docutils literal notranslate"><span class=pre >"ex14_false_omission_rate"</span></code>.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[28]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >CUTOFF</span> <span class=o >=</span> <span class=mf >0.08</span>
<span class=n >conf_matrix</span> <span class=o >=</span> <span class=n >confusion_matrix</span><span class=p >(</span><span class=n >y_test</span><span class=p >,</span> <span class=p >(</span><span class=n >y_pred_proba</span> <span class=o >&gt;</span> <span class=n >CUTOFF</span><span class=p >))</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"Confusion matrix with </span><span class=si >{</span><span class=n >CUTOFF</span><span class=si >}</span><span class=s2 > cutoff:</span><span class=se >\n</span><span class=si >{</span><span class=n >conf_matrix</span><span class=si >}</span><span class=s2 >"</span><span class=p >)</span>

<span class=n >results</span><span class=p >[</span><span class=s2 >"ex14_false_omission_rate"</span><span class=p >]</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span>
    <span class=n >conf_matrix</span><span class=p >[</span><span class=mi >1</span><span class=p >,</span> <span class=mi >0</span><span class=p >]</span> <span class=o >/</span> <span class=n >np</span><span class=o >.</span><span class=n >sum</span><span class=p >(</span><span class=n >conf_matrix</span><span class=p >[:,</span> <span class=mi >0</span><span class=p >])</span>
<span class=p >)</span>
<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"The False Omission Rate at </span><span class=si >{</span><span class=n >CUTOFF</span><span class=si >}</span><span class=s2 > is:</span><span class=se >\n</span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex14_false_omission_rate'</span><span class=p >]</span><span class=si >:</span><span class=s2 >.2%</span><span class=si >}</span><span class=s2 >"</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Confusion matrix with 0.08 cutoff:
[[2387  768]
 [ 123  133]]
The False Omission Rate at 0.08 is:
4.90%
</pre></div></div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[29]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >pd_confusion_matrix</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >crosstab</span><span class=p >(</span>
    <span class=n >y_test</span><span class=o >.</span><span class=n >squeeze</span><span class=p >(),</span>
    <span class=p >(</span><span class=n >y_pred_proba</span> <span class=o >&gt;</span> <span class=n >CUTOFF</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >),</span>
    <span class=n >rownames</span><span class=o >=</span><span class=p >[</span><span class=s2 >"Actual"</span><span class=p >],</span>
    <span class=n >colnames</span><span class=o >=</span><span class=p >[</span><span class=s2 >"Predicted"</span><span class=p >],</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[30]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >pd_confusion_matrix</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[30]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th>Predicted <th>0 <th>1 <tr> <th>Actual <th> <th> <tr> <th>0.0 <td>2387 <td>768 <tr> <th>1.0 <td>123 <td>133 </table> </div></div> </div> </section> <section id=Exercise-15 > <h3 id=Exercise-15 >Exercise 15<a class=headerlink  href="#Exercise-15" title="Link to this heading">¶</a></h3> <p>Your stakeholder wants to by as many mortgages as it can while maintaining a delinquency rate of purchased mortgages below 5%. Based on your answer above, do you feel like your model can provide that level of performance?</p> <blockquote> <div><p>Well, the result above says yes (4.9%), but how confident should we be in that number?? We’ll see!</p> </div></blockquote> </section> </section> <section id=Now-To-The-Future > <h2 id=Now-To-The-Future >Now To The Future<a class=headerlink  href="#Now-To-The-Future" title="Link to this heading">¶</a></h2> <p>The preceding analysis is precisely the type of analysis you would do if, in late 2006, you’d been asked to evaluate mortgage performance in the last two years for use going forward. So let’s see how your model performs now!</p> <p>In this <a class="reference external" href="https://github.com/nickeubank/MIDS_Data/tree/master/mortgages/2007">folder</a> you will find data on mortgages originated in 2007 along with servicing data from 2007, 2008, and 2009.</p> <section id=Exercise-16 > <h3 id=Exercise-16 >Exercise 16<a class=headerlink  href="#Exercise-16" title="Link to this heading">¶</a></h3> <p>Please load this data (again, from a URL to help the autograder) and clean it in the same manner as before. As a sanity check, how many observations do you have in the final dataset (after you’ve removed observations with missing values to allow you to generate predicted delinquency rates)?</p> <p>Store the final number of observations in <code class="docutils literal notranslate"><span class=pre >"ex16_num_obs"</span></code> and the share of those mortgages that are delinquent in <code class="docutils literal notranslate"><span class=pre >"ex16_share_delinquent"</span></code></p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[31]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 >###########</span>
<span class=c1 ># Load</span>
<span class=c1 >###########</span>

<span class=n >mortgages_2007</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span>
    <span class=s2 >"https://github.com/nickeubank/MIDS_Data/raw/master/mortgages/2007/sample_orig_2007.txt"</span><span class=p >,</span>
    <span class=n >sep</span><span class=o >=</span><span class=s2 >"|"</span><span class=p >,</span>
    <span class=n >names</span><span class=o >=</span><span class=n >origination_colnames</span><span class=p >,</span>
<span class=p >)</span>
<span class=n >servicing_2007</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span>
    <span class=s2 >"https://github.com/nickeubank/MIDS_Data/raw/master/mortgages/2007/sample_svcg_2007orig_3years.txt"</span><span class=p >,</span>
    <span class=n >sep</span><span class=o >=</span><span class=s2 >"|"</span><span class=p >,</span>
    <span class=n >names</span><span class=o >=</span><span class=n >service_colnames</span><span class=p >,</span>
<span class=p >)</span>

<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"2007 data has </span><span class=si >{</span><span class=nb >len</span><span class=p >(</span><span class=n >mortgages_2007</span><span class=p >)</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > new mortgages"</span><span class=p >)</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"2007 data has </span><span class=si >{</span><span class=nb >len</span><span class=p >(</span><span class=n >servicing_2007</span><span class=p >)</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 > servicing records"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
2007 data has 50,000 new mortgages
2007 data has 1,277,771 servicing records
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/fs/h_8_rwsn5hvg9mhp0txgc_s9v6191b/T/ipykernel_20548/507551674.py:10: DtypeWarning: Columns (8,24) have mixed types. Specify dtype option on import or set low_memory=False.
  servicing_2007 = pd.read_csv(
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[32]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 >########</span>
<span class=c1 ># NOTE: In any serious real workflow,</span>
<span class=c1 ># the way to do this would be to write a .py script</span>
<span class=c1 ># and parameterize it, not copy-paste the code.</span>
<span class=c1 ># This kind of duplication invites problems if, for</span>
<span class=c1 ># example, you change code above and forget to change it</span>
<span class=c1 ># down here as well.</span>
<span class=c1 >########</span>

<span class=c1 ># Life becomes way easier if I add this here,</span>
<span class=n >servicing_2007</span> <span class=o >=</span> <span class=n >servicing_2007</span><span class=p >[</span>
    <span class=p >[</span>
        <span class=s2 >"Monthly Reporting Period"</span><span class=p >,</span>
        <span class=s2 >"Current Loan Delinquency Status"</span><span class=p >,</span>
        <span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=p >]</span>
<span class=p >]</span>

<span class=n >combined_2007</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >merge</span><span class=p >(</span>
    <span class=n >mortgages_2007</span><span class=p >,</span>
    <span class=n >servicing_2007</span><span class=p >,</span>
    <span class=n >on</span><span class=o >=</span><span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=n >how</span><span class=o >=</span><span class=s2 >"inner"</span><span class=p >,</span>
    <span class=n >validate</span><span class=o >=</span><span class=s2 >"1:m"</span><span class=p >,</span>
    <span class=n >indicator</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
<span class=p >)</span>
<span class=n >combined_2007</span><span class=o >.</span><span class=n >_merge</span><span class=o >.</span><span class=n >value_counts</span><span class=p >()</span>
<span class=k >assert</span> <span class=p >(</span><span class=n >combined_2007</span><span class=o >.</span><span class=n >_merge</span> <span class=o >!=</span> <span class=s2 >"right_only"</span><span class=p >)</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>

<span class=c1 ># For purchase</span>
<span class=n >combined_2007</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"Loan Purpose"</span><span class=p >]</span> <span class=o >==</span> <span class=s2 >"P"</span><span class=p >]</span>

<span class=c1 ># First payment</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"First Payment Date"</span><span class=p >]</span> <span class=o >//</span> <span class=mi >100</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"month_first"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"First Payment Date"</span><span class=p >]</span> <span class=o >%</span> <span class=mi >100</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >=</span> <span class=p >((</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"month_first"</span><span class=p >]</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >//</span> <span class=mi >3</span><span class=p >)</span> <span class=o >+</span> <span class=mi >1</span>
<span class=k >assert</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span><span class=o >.</span><span class=n >isin</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=mi >5</span><span class=p >))</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>

<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_decimal_first"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >+</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"month_first"</span><span class=p >]</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >/</span> <span class=mi >12</span>
<span class=p >)</span>

<span class=c1 ># Origination. Get from loan sequence number.</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >str</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=mi >2</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span> <span class=o >+</span> <span class=mi >2000</span>
<span class=p >)</span>
<span class=k >assert</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >2007</span><span class=p >)</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >str</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=mi >4</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
<span class=p >)</span>
<span class=k >assert</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span><span class=o >.</span><span class=n >isin</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=mi >5</span><span class=p >))</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>


<span class=c1 ># Keep only if same or following quarter</span>
<span class=n >same_quarter_2007</span> <span class=o >=</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >==</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >])</span> <span class=o >&amp;</span> <span class=p >(</span>
    <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >==</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span>
<span class=p >)</span>
<span class=n >next_quarter_same_year_2007</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >==</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span>
<span class=p >)</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >==</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span> <span class=o >+</span> <span class=mi >1</span><span class=p >))</span>
<span class=n >next_quarter_next_year_2007</span> <span class=o >=</span> <span class=p >(</span>
    <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_first"</span><span class=p >]</span> <span class=o >==</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_orig"</span><span class=p >]</span> <span class=o >+</span> <span class=mi >1</span><span class=p >))</span>
    <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_first"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >)</span>
    <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"quarter_orig"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >4</span><span class=p >)</span>
<span class=p >)</span>
<span class=n >combined_2007</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[</span>
    <span class=n >same_quarter_2007</span> <span class=o >|</span> <span class=n >next_quarter_same_year_2007</span> <span class=o >|</span> <span class=n >next_quarter_next_year_2007</span>
<span class=p >]</span>

<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_reporting"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"Monthly Reporting Period"</span><span class=p >]</span> <span class=o >//</span> <span class=mi >100</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"month_reporting"</span><span class=p >]</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"Monthly Reporting Period"</span><span class=p >]</span> <span class=o >%</span> <span class=mi >100</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_decimal_reporting"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_reporting"</span><span class=p >]</span> <span class=o >+</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"month_reporting"</span><span class=p >]</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >/</span> <span class=mi >12</span>
<span class=p >)</span>

<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >round</span><span class=p >(</span>
    <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_decimal_reporting"</span><span class=p >]</span> <span class=o >-</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"year_decimal_first"</span><span class=p >]),</span> <span class=mi >4</span>
<span class=p >)</span>
<span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span><span class=o >.</span><span class=n >value_counts</span><span class=p >()</span><span class=o >.</span><span class=n >sort_index</span><span class=p >()</span>

<span class=n >two_years_2007</span> <span class=o >=</span> <span class=n >combined_2007</span><span class=p >[(</span><span class=mi >0</span> <span class=o >&lt;=</span> <span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >])</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >combined_2007</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span> <span class=o >&lt;</span> <span class=mi >2</span><span class=p >)]</span>
<span class=k >assert</span> <span class=nb >len</span><span class=p >(</span><span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"age"</span><span class=p >]</span><span class=o >.</span><span class=n >value_counts</span><span class=p >())</span> <span class=o >==</span> <span class=mi >24</span>

<span class=c1 ># Current Loan Delinquency Status</span>
<span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Current Loan Delinquency Status"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Current Loan Delinquency Status"</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"RA"</span><span class=p >,</span> <span class=mi >99</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
<span class=p >)</span>

<span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"ever_delinquent"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >two_years_2007</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=s2 >"Loan Sequence Number"</span><span class=p >)[</span>
        <span class=s2 >"Current Loan Delinquency Status"</span>
    <span class=p >]</span><span class=o >.</span><span class=n >transform</span><span class=p >(</span><span class=s2 >"max"</span><span class=p >)</span>
    <span class=o >&gt;</span> <span class=mi >0</span>
<span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>

<span class=c1 ># This is made easier by drops earlier.</span>
<span class=n >two_years_2007</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span>
    <span class=n >columns</span><span class=o >=</span><span class=p >[</span>
        <span class=s2 >"Current Loan Delinquency Status"</span><span class=p >,</span>
        <span class=s2 >"Monthly Reporting Period"</span><span class=p >,</span>
        <span class=s2 >"month_reporting"</span><span class=p >,</span>
        <span class=s2 >"year_reporting"</span><span class=p >,</span>
        <span class=s2 >"year_decimal_reporting"</span><span class=p >,</span>
        <span class=s2 >"age"</span><span class=p >,</span>
        <span class=s2 >"_merge"</span><span class=p >,</span>
    <span class=p >]</span>
<span class=p >)</span>
<span class=n >two_years_2007</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=o >.</span><span class=n >drop_duplicates</span><span class=p >()</span>
<span class=k >assert</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Loan Sequence Number"</span><span class=p >]</span><span class=o >.</span><span class=n >is_unique</span>

<span class=c1 >###########</span>
<span class=c1 ># Clean up missing values</span>
<span class=c1 >###########</span>

<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=p >[</span>
    <span class=s2 >"Channel"</span><span class=p >,</span>
    <span class=s2 >"Property Valuation Method"</span><span class=p >,</span>
    <span class=s2 >"First Time Homebuyer Flag"</span><span class=p >,</span>
    <span class=s2 >"Occupancy Status"</span><span class=p >,</span>
<span class=p >]:</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >9</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"9"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>

<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=p >[</span><span class=s2 >"Number of Units"</span><span class=p >,</span> <span class=s2 >"Property Type"</span><span class=p >,</span> <span class=s2 >"Number of Borrowers"</span><span class=p >]:</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >99</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"99"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>

<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=p >[</span>
    <span class=s2 >"Mortgage Insurance Percentage (MI %)"</span><span class=p >,</span>
    <span class=s2 >"Original Debt-to-Income (DTI) Ratio"</span><span class=p >,</span>
    <span class=s2 >"Original Loan-to-Value (LTV)"</span><span class=p >,</span>
<span class=p >]:</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >999</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
    <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=n >i</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"999"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>

<span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=mi >9999</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>
<span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span><span class=s2 >"Credit Score"</span><span class=p >]</span><span class=o >.</span><span class=n >replace</span><span class=p >(</span><span class=s2 >"9999"</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >)</span>

<span class=n >for_ml_2007</span> <span class=o >=</span> <span class=n >two_years_2007</span><span class=p >[</span>
    <span class=p >[</span>
        <span class=s2 >"Credit Score"</span><span class=p >,</span>
        <span class=s2 >"First Time Homebuyer Flag"</span><span class=p >,</span>
        <span class=s2 >"Number of Units"</span><span class=p >,</span>
        <span class=s2 >"Mortgage Insurance Percentage (MI %)"</span><span class=p >,</span>
        <span class=s2 >"Occupancy Status"</span><span class=p >,</span>
        <span class=s2 >"Original Debt-to-Income (DTI) Ratio"</span><span class=p >,</span>
        <span class=s2 >"Original UPB"</span><span class=p >,</span>
        <span class=s2 >"Original Loan-to-Value (LTV)"</span><span class=p >,</span>
        <span class=s2 >"Original Interest Rate"</span><span class=p >,</span>
        <span class=s2 >"Channel"</span><span class=p >,</span>
        <span class=s2 >"Prepayment Penalty Mortgage (PPM) Flag"</span><span class=p >,</span>
        <span class=s2 >"Amortization Type (Formerly Product Type)"</span><span class=p >,</span>
        <span class=s2 >"Property State"</span><span class=p >,</span>
        <span class=s2 >"Property Type"</span><span class=p >,</span>
        <span class=s2 >"Original Loan Term"</span><span class=p >,</span>
        <span class=s2 >"Number of Borrowers"</span><span class=p >,</span>
        <span class=s2 >"Interest Only (I/O) Indicator"</span><span class=p >,</span>
        <span class=s2 >"ever_delinquent"</span><span class=p >,</span>
        <span class=s2 >"Loan Sequence Number"</span><span class=p >,</span>
    <span class=p >]</span>
<span class=p >]</span>

<span class=n >for_ml_2007</span> <span class=o >=</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >sort_values</span><span class=p >(</span><span class=s2 >"Loan Sequence Number"</span><span class=p >)</span>

<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >" "</span><span class=p >,</span> <span class=s2 >"_"</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"%"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"/"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"\("</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"\)"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=p >[</span><span class=n >re</span><span class=o >.</span><span class=n >sub</span><span class=p >(</span><span class=s2 >"-"</span><span class=p >,</span> <span class=s2 >""</span><span class=p >,</span> <span class=n >c</span><span class=p >)</span> <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>

<span class=n >for_ml_2007</span><span class=o >.</span><span class=n >columns</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[32]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Index(['Credit_Score', 'First_Time_Homebuyer_Flag', 'Number_of_Units',
       'Mortgage_Insurance_Percentage_MI_', 'Occupancy_Status',
       'Original_DebttoIncome_DTI_Ratio', 'Original_UPB',
       'Original_LoantoValue_LTV', 'Original_Interest_Rate', 'Channel',
       'Prepayment_Penalty_Mortgage_PPM_Flag',
       'Amortization_Type_Formerly_Product_Type', 'Property_State',
       'Property_Type', 'Original_Loan_Term', 'Number_of_Borrowers',
       'Interest_Only_IO_Indicator', 'ever_delinquent',
       'Loan_Sequence_Number'],
      dtype='object')
</pre></div></div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[33]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >y_2007</span><span class=p >,</span> <span class=n >X_2007</span> <span class=o >=</span> <span class=n >patsy</span><span class=o >.</span><span class=n >dmatrices</span><span class=p >(</span>
    <span class=s2 >"ever_delinquent ~ Credit_Score"</span>
    <span class=s2 >"+ First_Time_Homebuyer_Flag"</span>
    <span class=s2 >"+ C(Number_of_Units)"</span>
    <span class=s2 >"+ Mortgage_Insurance_Percentage_MI_"</span>
    <span class=s2 >"+ Occupancy_Status"</span>
    <span class=s2 >"+ Original_DebttoIncome_DTI_Ratio"</span>
    <span class=s2 >"+ Original_UPB"</span>
    <span class=s2 >"+ Original_LoantoValue_LTV"</span>
    <span class=s2 >"+ Original_Interest_Rate"</span>
    <span class=s2 >"+ Channel"</span>
    <span class=s2 >"+ Prepayment_Penalty_Mortgage_PPM_Flag"</span>
    <span class=s2 >"+ Amortization_Type_Formerly_Product_Type"</span>
    <span class=s2 >"+ Property_State"</span>
    <span class=s2 >"+ Property_Type"</span>
    <span class=s2 >"+ Original_Loan_Term"</span>
    <span class=s2 >"+ C(Number_of_Borrowers)"</span>
    <span class=s2 >"+ Interest_Only_IO_Indicator"</span><span class=p >,</span>
    <span class=n >for_ml_2007</span><span class=p >,</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[34]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >results</span><span class=p >[</span><span class=s2 >"ex16_num_obs"</span><span class=p >]</span> <span class=o >=</span> <span class=n >X_2007</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
<span class=n >results</span><span class=p >[</span><span class=s2 >"ex16_share_delinquent"</span><span class=p >]</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >y_2007</span><span class=o >.</span><span class=n >mean</span><span class=p >())</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"Num obs in the 2007 data is </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex16_num_obs'</span><span class=p >]</span><span class=si >:</span><span class=s2 >,.0f</span><span class=si >}</span><span class=s2 >"</span><span class=p >)</span>
<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"share of these 2007 morgages that are delinquent is </span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex16_share_delinquent'</span><span class=p >]</span><span class=si >:</span><span class=s2 >.2%</span><span class=si >}</span><span class=s2 >"</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Num obs in the 2007 data is 21,972
share of these 2007 morgages that are delinquent is 10.96%
</pre></div></div> </div> </section> <section id=Exercise-17 > <h3 id=Exercise-17 >Exercise 17<a class=headerlink  href="#Exercise-17" title="Link to this heading">¶</a></h3> <p>Had your stakeholder purchased mortgages using your model (with the 8% cutoff), what would the resulting False Omission Rate (share of predicted negatives that are false negatives) rate have been? (e.g., compare the predicted values for mortgages using the model trained above with realized outcomes).</p> <p>Store your result under the key <code class="docutils literal notranslate"><span class=pre >"ex17_false_omission_rate"</span></code>. Round your answer to <strong>4 decimal places.</strong></p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[35]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Predicts</span>
<span class=n >y_2007_pred_proba</span> <span class=o >=</span> <span class=n >gb</span><span class=o >.</span><span class=n >predict_proba</span><span class=p >(</span><span class=n >X_2007</span><span class=p >)[:,</span> <span class=mi >1</span><span class=p >]</span>
<span class=n >conf_matrix_2007</span> <span class=o >=</span> <span class=n >confusion_matrix</span><span class=p >(</span><span class=n >y_2007</span><span class=p >,</span> <span class=p >(</span><span class=n >y_2007_pred_proba</span> <span class=o >&gt;</span> <span class=n >CUTOFF</span><span class=p >))</span>
<span class=nb >print</span><span class=p >(</span><span class=sa >f</span><span class=s2 >"Confusion matrix with </span><span class=si >{</span><span class=n >CUTOFF</span><span class=si >}</span><span class=s2 > cutoff:</span><span class=se >\n</span><span class=si >{</span><span class=n >conf_matrix_2007</span><span class=si >}</span><span class=s2 >"</span><span class=p >)</span>

<span class=c1 ># false_rate = float(conf_matrix_2007[1, 0] / np.sum(conf_matrix_2007[:, 0]))</span>

<span class=c1 ># results["ex17_false_omission_rate"] = np.round(false_rate, 4)</span>


<span class=n >results</span><span class=p >[</span><span class=s2 >"ex17_false_omission_rate"</span><span class=p >]</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span>
    <span class=n >conf_matrix_2007</span><span class=p >[</span><span class=mi >1</span><span class=p >,</span> <span class=mi >0</span><span class=p >]</span> <span class=o >/</span> <span class=n >np</span><span class=o >.</span><span class=n >sum</span><span class=p >(</span><span class=n >conf_matrix_2007</span><span class=p >[:,</span> <span class=mi >0</span><span class=p >])</span>
<span class=p >)</span>

<span class=nb >print</span><span class=p >(</span>
    <span class=sa >f</span><span class=s2 >"The False Omission Rate at </span><span class=si >{</span><span class=n >CUTOFF</span><span class=si >}</span><span class=s2 > for 2007 data is:"</span>
    <span class=sa >f</span><span class=s2 >"</span><span class=se >\n</span><span class=si >{</span><span class=n >results</span><span class=p >[</span><span class=s1 >'ex17_false_omission_rate'</span><span class=p >]</span><span class=si >:</span><span class=s2 >.2%</span><span class=si >}</span><span class=s2 >"</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
Confusion matrix with 0.08 cutoff:
[[14487  5076]
 [  847  1562]]
The False Omission Rate at 0.08 for 2007 data is:
5.52%
</pre></div></div> </div> </section> <section id=Exercise-18 > <h3 id=Exercise-18 >Exercise 18<a class=headerlink  href="#Exercise-18" title="Link to this heading">¶</a></h3> <p>How did the retrospective performance of your model compare to its actual performance moving forward? Why? Did you stay below the 5% target for mortgages that were predicted to be safe but in the end were not set by the stakeholder?</p> <blockquote> <div><p>Nope. split-train-test only tells you about accuracy you can expect <em>internally</em>; it doesn’t account for <em>external validity</em> induced uncertainty.</p> </div></blockquote> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[38]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=k >assert</span> <span class=nb >set</span><span class=p >(</span><span class=n >results</span><span class=o >.</span><span class=n >keys</span><span class=p >())</span> <span class=o >==</span> <span class=p >{</span>
    <span class=s2 >"ex2_merge_type"</span><span class=p >,</span>
    <span class=s2 >"ex4_num_mortgages"</span><span class=p >,</span>
    <span class=s2 >"ex5_num_obs"</span><span class=p >,</span>
    <span class=s2 >"ex7_num_mortgages"</span><span class=p >,</span>
    <span class=s2 >"ex7_share_delinquent"</span><span class=p >,</span>
    <span class=s2 >"ex10_num_obs"</span><span class=p >,</span>
    <span class=s2 >"ex12_roc_auc"</span><span class=p >,</span>
    <span class=s2 >"ex14_false_omission_rate"</span><span class=p >,</span>
    <span class=s2 >"ex16_num_obs"</span><span class=p >,</span>
    <span class=s2 >"ex16_share_delinquent"</span><span class=p >,</span>
    <span class=s2 >"ex17_false_omission_rate"</span><span class=p >,</span>
<span class=p >}</span>
</pre></div> </div> </div> </section> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2022, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.2.6. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
<!DOCTYPE html> <html lang=en  data-content_root="../"> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=viewport  content="width=device-width, initial-scale=1" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151397036-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-151397036-1'); </script> <title>Groupby and Arrest Data &#8212; Unifying Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css?v=649a27d8" /> <link rel=stylesheet  type="text/css" href="../_static/material.css?v=79c92029" /> <link rel=stylesheet  type="text/css" href="../_static/nbsphinx-code-cells.css?v=b9dd2d90" /> <script src="../_static/documentation_options.js?v=5929fcd5"></script> <script src="../_static/doctools.js?v=888ff710"></script> <script src="../_static/sphinx_highlight.js?v=dc90522c"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel=icon  href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#exercises/solutions_diffindiff" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Unifying Data Science" class="md-header-nav__button md-logo"> &nbsp; </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Unifying Data Science</span> <span class=md-header-nav__topic > Groupby and Arrest Data </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=""Search"" autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Unifying Data Science" class="md-nav__button md-logo"> <img src="../_static/" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Unifying Data Science">Unifying Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >CLASS SCHEDULE</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Causal Inference</span></span> <li class=md-nav__item > <a href="../limitations_of_ATE.html" class=md-nav__link >Limitations of ATE</a> <li class=md-nav__item > <a href="../internal_v_external_validity.html" class=md-nav__link >Internal v. External Validity</a> <li class=md-nav__item > <a href="../evaluating_real_studies.html" class=md-nav__link >Evaluating A Real Study</a> <li class=md-nav__item > <a href="../causal_inference_beyond_ab_testing.html" class=md-nav__link >Beyond AB Testing</a> <li class=md-nav__item > <a href="../matching_why.html" class=md-nav__link >Matching (Why)</a> <li class=md-nav__item > <a href="../matching_how.html" class=md-nav__link >Matching (How)</a> <li class=md-nav__item > <a href="../interpreting_indicator_vars.html" class=md-nav__link >Indicator Variables</a> <li class=md-nav__item > <a href="../fixed_effects.html" class=md-nav__link >Fixed Effects (FEs)</a> <li class=md-nav__item > <a href="../fixed_effects_and_causal_inference.html" class=md-nav__link >FEs & Causality</a> <li class=md-nav__item > <a href="../fixed_effects_v_hierarchical.html" class=md-nav__link >FEs & Hierarchical Models</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Data Science Project Design</span></span> <li class=md-nav__item > <a href="../backwards_design.html" class=md-nav__link >Backwards Design</a> <li class=md-nav__item > <a href="../taxonomy_of_questions.html" class=md-nav__link >Taxonomy of Questions</a> <li class=md-nav__item > <a href="../moving_from_problems_to_questions.html" class=md-nav__link >From Problems to Questions</a> <li class=md-nav__item > <a href="../descriptive_questions.html" class=md-nav__link >Discretion and Description</a> <li class=md-nav__item > <a href="../ethical_ml_recommendations.html" class=md-nav__link >Ethical Machine Learning</a> <li class=md-nav__item > <a href="../writing_to_stakeholders.html" class=md-nav__link >Writing for Lay Audiences</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >"Contents"</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#exercises-solutions-diffindiff--page-root" class=md-nav__link >Groupby and Arrest Data</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-1" class=md-nav__link >Exercise 1</a> <li class=md-nav__item ><a href="#Exercise-2" class=md-nav__link >Exercise 2</a> <li class=md-nav__item ><a href="#Exercise-3" class=md-nav__link >Exercise 3</a> <li class=md-nav__item ><a href="#Exercise-4" class=md-nav__link >Exercise 4</a> <li class=md-nav__item ><a href="#Exercise-5" class=md-nav__link >Exercise 5</a> <li class=md-nav__item ><a href="#Exercise-6" class=md-nav__link >Exercise 6</a> <li class=md-nav__item ><a href="#Exercise-7" class=md-nav__link >Exercise 7</a> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <section id=Groupby-and-Arrest-Data > <h1 id=exercises-solutions-diffindiff--page-root >Groupby and Arrest Data<a class=headerlink  href="#exercises-solutions-diffindiff--page-root" title="Link to this heading">¶</a></h1> <p>In recent years, many US states have decided to legalize the use of marijuana.</p> <p>When these ideas were first proposed, there were many theories about the relationship between crime and the “War on Drugs” (the term given to US efforts to arrest drug users and dealers over the past several decades).</p> <p>In this exercise, we’re going to test a few of those theories using drug arrest data from the state of California.</p> <p>Though California has passed a number of laws lessening penalities for marijuana possession over the years, arguably the biggest changes were in 2010, when the state changed the penalty for possessing a small amount of marijuana from a criminal crime to a “civil” penality (meaning those found guilty only had to pay a fine, not go to jail), though possessing, selling, or producing larger quantities remained illegal. Then in 2016, the state fully legalized marijuana for recreational use, not only making possession of small amounts legal, but also creating a regulatory system for producing marijuana for sale.</p> <p>Proponents of drug legalization have long argued that the war on drugs contributes to violent crime by creating an opportunity for drug dealers and organized crime to sell and distribute drugs, a business which tends to generate violence when gangs battle over territory. According to this theory, with drug legalization, we should see violent crime decrease after legalization in places where drug arrests had previously been common.</p> <p><strong>To be clear,</strong> this is far from the only argument for drug legalization! It is simply the argument we are well positioned to analyze today.</p> <p>(Students from Practical Data Science: This should sound familiar! Last semester we did this analysis in a very simple, crude manner; in this class we’ll do it rigorously with your new found difference-in-differences skills!)</p> <section id=Exercise-1 > <h2 id=Exercise-1 >Exercise 1<a class=headerlink  href="#Exercise-1" title="Link to this heading">¶</a></h2> <p>Download and import California arrest data from <a class="reference external" href="https://www.github.com/nickeubank/MIDS_Data/UDS_arrest_data.csv">https://www.github.com/nickeubank/MIDS_Data/UDS_arrest_data.csv</a>. What is a unit of observation (a single row) in this data? What entities are being tracked, and over what time period?</p> <p>Note that <code class="docutils literal notranslate"><span class=pre >VIOLENT</span></code> is a count of arrests for violent offenses, and <code class="docutils literal notranslate"><span class=pre >F_DRUGOFF</span></code> is a count of felony drug arrests. <code class="docutils literal notranslate"><span class=pre >total_population</span></code> is total population.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>

<span class=n >arrests</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span>
    <span class=s2 >"https://media.githubusercontent.com/media/"</span>
    <span class=s2 >"nickeubank/MIDS_Data/master/UDS_arrest_data.csv"</span>
<span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >arrests</span><span class=o >.</span><span class=n >head</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>YEAR <th>COUNTY <th>VIOLENT <th>F_DRUGOFF <th>total_population <tr> <th>0 <td>1980 <td>Alameda County <td>4504 <td>3569 <td>1105379.0 <tr> <th>1 <td>1981 <td>Alameda County <td>4699 <td>3926 <td>1122759.3 <tr> <th>2 <td>1982 <td>Alameda County <td>4389 <td>4436 <td>1140139.6 <tr> <th>3 <td>1983 <td>Alameda County <td>4500 <td>5086 <td>1157519.9 <tr> <th>4 <td>1984 <td>Alameda County <td>3714 <td>5878 <td>1174900.2 </table> </div></div> </div> </section> <section id=Exercise-2 > <h2 id=Exercise-2 >Exercise 2<a class=headerlink  href="#Exercise-2" title="Link to this heading">¶</a></h2> <p>In this analysis, we will split our sample into “treated” and “control” counties on the basis of whether a given county had a high average drug arrest rate in the three years before California began drug legalization in 2010. Counties with high drug arrest rates, after all, will be more impacted by drug liberalization policies.</p> <p>Calculate each county’s average drug arrest <em>rate</em> for the period from 2007-2009. Then calculate the median value across counties, and create an indicator called <code class="docutils literal notranslate"><span class=pre >treated</span></code> for counties whose average drug arrest rate during this period was above the median average drug arrest rate. In other words, half your counties should be in the “treated” group, and half in “control”.</p> <p>Note that this indicator should be <em>time-invariant</em>—if a county is in the treated group, it should always be identified as being in the treated group.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >arrests</span><span class=p >[</span><span class=s2 >"drug_rate"</span><span class=p >]</span> <span class=o >=</span> <span class=n >arrests</span><span class=o >.</span><span class=n >F_DRUGOFF</span> <span class=o >/</span> <span class=p >(</span><span class=n >arrests</span><span class=o >.</span><span class=n >total_population</span> <span class=o >/</span> <span class=mi >100_000</span><span class=p >)</span>
<span class=n >arrests</span><span class=p >[</span><span class=s2 >"violent_rate"</span><span class=p >]</span> <span class=o >=</span> <span class=n >arrests</span><span class=o >.</span><span class=n >VIOLENT</span> <span class=o >/</span> <span class=p >(</span><span class=n >arrests</span><span class=o >.</span><span class=n >total_population</span> <span class=o >/</span> <span class=mi >100_000</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >small</span> <span class=o >=</span> <span class=n >arrests</span><span class=p >[</span><span class=n >arrests</span><span class=o >.</span><span class=n >YEAR</span><span class=o >.</span><span class=n >isin</span><span class=p >([</span><span class=mi >2007</span><span class=p >,</span> <span class=mi >2008</span><span class=p >,</span> <span class=mi >2009</span><span class=p >])]</span>
<span class=n >avgs</span> <span class=o >=</span> <span class=n >small</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=s2 >"COUNTY"</span><span class=p >)</span><span class=o >.</span><span class=n >drug_rate</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
<span class=n >avgs</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
COUNTY
Alameda County            394.457331
Alpine County             197.551801
Amador County             289.027292
Butte County              271.709690
Calaveras County          312.159811
Colusa County             209.450372
Contra Costa County       276.018946
Del Norte County          358.305449
El Dorado County          228.874748
Fresno County             473.876866
Glenn County              411.831533
Humboldt County           499.572904
Imperial County           460.694485
Inyo County               380.164074
Kern County               432.659812
Kings County              208.035930
Lake County               369.871380
Lassen County             147.165387
Los Angeles County        403.990696
Madera County             261.117203
Marin County              190.030996
Mariposa County           232.969880
Mendocino County          599.799767
Merced County             441.290221
Modoc County              211.204960
Mono County               272.602759
Monterey County           248.094595
Napa County               247.823080
Nevada County             235.403323
Orange County             277.267304
Placer County             290.583530
Plumas County             492.429787
Riverside County          291.458787
Sacramento County         375.134854
San Benito County         210.849718
San Bernardino County     465.333881
San Diego County          249.177208
San Francisco County      873.961738
San Joaquin County        336.824184
San Luis Obispo County    192.583757
San Mateo County          214.668466
Santa Barbara County      225.267192
Santa Clara County        261.348166
Santa Cruz County         322.577393
Shasta County             257.470436
Sierra County             221.364059
Siskiyou County           352.795109
Solano County             388.929454
Sonoma County             331.905273
Stanislaus County         457.198700
Sutter County             207.695398
Tehama County             585.300555
Trinity County            427.859162
Tulare County             447.774248
Tuolumne County           405.897681
Ventura County            264.878553
Yolo County               333.788690
Yuba County               351.561100
Name: drug_rate, dtype: float64
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >avgs</span><span class=o >.</span><span class=n >median</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
301.8092992253924
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >high</span> <span class=o >=</span> <span class=p >(</span><span class=n >avgs</span> <span class=o >&gt;</span> <span class=n >avgs</span><span class=o >.</span><span class=n >median</span><span class=p >())</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
<span class=n >high</span><span class=o >.</span><span class=n >name</span> <span class=o >=</span> <span class=s2 >"treated"</span>
<span class=n >high</span><span class=o >.</span><span class=n >head</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
COUNTY
Alameda County      1
Alpine County       0
Amador County       0
Butte County        0
Calaveras County    1
Name: treated, dtype: int64
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >arrests</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >merge</span><span class=p >(</span>
    <span class=n >arrests</span><span class=p >,</span>
    <span class=n >high</span><span class=p >,</span>
    <span class=n >left_on</span><span class=o >=</span><span class=s2 >"COUNTY"</span><span class=p >,</span>
    <span class=n >right_index</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
    <span class=n >how</span><span class=o >=</span><span class=s2 >"outer"</span><span class=p >,</span>
    <span class=n >indicator</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
    <span class=n >validate</span><span class=o >=</span><span class=s2 >"m:1"</span><span class=p >,</span>
<span class=p >)</span>
<span class=k >assert</span> <span class=p >(</span><span class=n >arrests</span><span class=o >.</span><span class=n >_merge</span> <span class=o >==</span> <span class=s2 >"both"</span><span class=p >)</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>
<span class=n >arrests</span> <span class=o >=</span> <span class=n >arrests</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=s2 >"_merge"</span><span class=p >,</span> <span class=n >axis</span><span class=o >=</span><span class=s2 >"columns"</span><span class=p >)</span>
<span class=n >arrests</span><span class=o >.</span><span class=n >head</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>YEAR <th>COUNTY <th>VIOLENT <th>F_DRUGOFF <th>total_population <th>drug_rate <th>violent_rate <th>treated <tr> <th>0 <td>1980 <td>Alameda County <td>4504 <td>3569 <td>1105379.0 <td>322.875683 <td>407.462056 <td>1 <tr> <th>1 <td>1981 <td>Alameda County <td>4699 <td>3926 <td>1122759.3 <td>349.674236 <td>418.522474 <td>1 <tr> <th>2 <td>1982 <td>Alameda County <td>4389 <td>4436 <td>1140139.6 <td>389.075162 <td>384.952860 <td>1 <tr> <th>3 <td>1983 <td>Alameda County <td>4500 <td>5086 <td>1157519.9 <td>439.387694 <td>388.762215 <td>1 <tr> <th>4 <td>1984 <td>Alameda County <td>3714 <td>5878 <td>1174900.2 <td>500.297813 <td>316.111956 <td>1 </table> </div></div> </div> </section> <section id=Exercise-3 > <h2 id=Exercise-3 >Exercise 3<a class=headerlink  href="#Exercise-3" title="Link to this heading">¶</a></h2> <p>Our outcome in this analysis is the violent arrest rate – if drug liberalization reduces crime overall, we would expect to see this rate fall in counties with high drug arrest rates after liberalization; if not, we would not expect to see any changes. Create a <code class="docutils literal notranslate"><span class=pre >violent_rate</span></code> variable with is violent arrests per 100,000 people.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># See above, already did!</span>
</pre></div> </div> </div> </section> <section id=Exercise-4 > <h2 id=Exercise-4 >Exercise 4<a class=headerlink  href="#Exercise-4" title="Link to this heading">¶</a></h2> <p>Differences-in-differences get their name from the fact that the estimator, in its most basic implementation, is just the difference between:</p> <ul class=simple > <li><p>difference in the average change in outcome among eventually-treated units from before to after when treatment is applied, and</p> <li><p>difference in the average change in outcome among never-treated units from before to after when treatment (to the treated units).</p> </ul> <p>(Obviously treatment is never a applied to the never-treated units – when we talk about pre / post, we refer to before and after the point in time in which treatment is applied to the treated units. So if treated units are treated in 2008, then for the never-treated units, we are also comparing outcomes before 2008 to after 2008, even though 2008 has no special significance for the never-treated units).</p> <p>In its most basic implementation, therefore, calculating a difference-in-difference estimate requires calculating just 4 numbers:</p> <ul class=simple > <li><p><span class="math notranslate nohighlight">\(\bar y_{T=1,Post}\)</span> Avg for Treatment, Post-Treatment</p> <li><p><span class="math notranslate nohighlight">\(\bar y_{T=0,Post}\)</span> Avg for Control, Post-Treatment</p> <li><p><span class="math notranslate nohighlight">\(\bar y_{T=1,Pre}\)</span> Avg for Treatment, Pre-Treatment</p> <li><p><span class="math notranslate nohighlight">\(\bar y_{T=0,Pre}\)</span> Avg for Control, Pre-Treatment</p> </ul> <p>The difference-in-differences estimator <span class="math notranslate nohighlight">\(\hat \delta\)</span> is defined as</p> <div class="math notranslate nohighlight"> \[\hat{\delta}= (\bar{y}_{T=1,\,Post}-\bar{y}_{T=1,\,Pre})-(\bar{y}_{T=0,\,Post}-\bar{y}_{T=0,\,Pre})\]</div> <p>Calculate (a) the change in violent arrest rates for our treated groups from before legalization to after (<span class="math notranslate nohighlight">\(\bar y_{T=1,Post} - \bar y_{T=1, Pre}\)</span>), and (b) our difference in difference estimator <span class="math notranslate nohighlight">\(\hat\delta\)</span> by calculating these four values. Does doing your difference-in-difference estimate tell you something different from what you’d learn if you had just done a pre-post comparison?</p> <p>For the <code class="docutils literal notranslate"><span class=pre >Pre</span></code> period, consider the three years before liberalization begins in 2010 (e.g. 2007-2009). For the <code class="docutils literal notranslate"><span class=pre >Post</span></code> period, consider the three years after final legalization took place (2016-2018). We will ignore the middle period in which marijuana was decriminalized but not yet legal.</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[9]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >arrests</span><span class=p >[</span><span class=s2 >"post_2010"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span><span class=n >arrests</span><span class=o >.</span><span class=n >YEAR</span> <span class=o >&gt;=</span> <span class=mi >2010</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=s2 >"int"</span><span class=p >)</span>
<span class=n >arrests_sub</span> <span class=o >=</span> <span class=n >arrests</span><span class=p >[</span><span class=n >arrests</span><span class=o >.</span><span class=n >YEAR</span><span class=o >.</span><span class=n >isin</span><span class=p >([</span><span class=mi >2007</span><span class=p >,</span> <span class=mi >2008</span><span class=p >,</span> <span class=mi >2009</span><span class=p >,</span> <span class=mi >2016</span><span class=p >,</span> <span class=mi >2017</span><span class=p >,</span> <span class=mi >2018</span><span class=p >])]</span>

<span class=n >y_t1_post</span> <span class=o >=</span> <span class=n >arrests_sub</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span>
    <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"treated"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >)</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"post_2010"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >),</span> <span class=s2 >"violent_rate"</span>
<span class=p >]</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>

<span class=n >y_t1_pre</span> <span class=o >=</span> <span class=n >arrests_sub</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span>
    <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"treated"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >)</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"post_2010"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >),</span> <span class=s2 >"violent_rate"</span>
<span class=p >]</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>

<span class=n >y_t0_post</span> <span class=o >=</span> <span class=n >arrests_sub</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span>
    <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"treated"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >)</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"post_2010"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >),</span> <span class=s2 >"violent_rate"</span>
<span class=p >]</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>

<span class=n >y_t0_pre</span> <span class=o >=</span> <span class=n >arrests_sub</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span>
    <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"treated"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >)</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >arrests_sub</span><span class=p >[</span><span class=s2 >"post_2010"</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >),</span> <span class=s2 >"violent_rate"</span>
<span class=p >]</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >y_t1_post</span> <span class=o >-</span> <span class=n >y_t1_pre</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
-26.799650070477355
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=p >(</span><span class=n >y_t1_post</span> <span class=o >-</span> <span class=n >y_t1_pre</span><span class=p >)</span> <span class=o >-</span> <span class=p >(</span><span class=n >y_t0_post</span> <span class=o >-</span> <span class=n >y_t0_pre</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
-7.418061484004568
</pre></div></div> </div> </section> <section id=Exercise-5 > <h2 id=Exercise-5 >Exercise 5<a class=headerlink  href="#Exercise-5" title="Link to this heading">¶</a></h2> <p>Now calculate <span class="math notranslate nohighlight">\(\hat\delta\)</span> using a regression with an indicator for post-2010, an indicator for treated, and an interaction of the two. Use only the same set of years you used above. How does your estimate compare to the estimate you calculated in Exercise 4?</p> <p>What does this tell you about interpretation of interaction terms with two indicator variables?</p> <p>Note: You need to cluster your standard errors by county, since we expect counties (over time) to be subject to common fluctuations.</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >statsmodels.formula.api</span> <span class=k >as</span> <span class=nn >smf</span>

<span class=n >m</span> <span class=o >=</span> <span class=n >smf</span><span class=o >.</span><span class=n >ols</span><span class=p >(</span><span class=s2 >"violent_rate ~ post_2010 * treated"</span><span class=p >,</span> <span class=n >arrests_sub</span><span class=p >)</span><span class=o >.</span><span class=n >fit</span><span class=p >()</span>
<span class=n >m</span><span class=o >.</span><span class=n >get_robustcov_results</span><span class=p >(</span><span class=n >cov_type</span><span class=o >=</span><span class=s2 >"cluster"</span><span class=p >,</span> <span class=n >groups</span><span class=o >=</span><span class=n >arrests_sub</span><span class=o >.</span><span class=n >COUNTY</span><span class=p >)</span><span class=o >.</span><span class=n >summary</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <table> <caption>OLS Regression Results</caption> <tr> <th>Dep. Variable: <td>violent_rate <th> R-squared: <td> 0.221 <tr> <th>Model: <td>OLS <th> Adj. R-squared: <td> 0.214 <tr> <th>Method: <td>Least Squares <th> F-statistic: <td> 11.00 <tr> <th>Date: <td>Mon, 06 Mar 2023 <th> Prob (F-statistic): <td>8.45e-06 <tr> <th>Time: <td>14:04:39 <th> Log-Likelihood: <td> -2094.1 <tr> <th>No. Observations: <td> 348 <th> AIC: <td> 4196. <tr> <th>Df Residuals: <td> 344 <th> BIC: <td> 4212. <tr> <th>Df Model: <td> 3 <th> <td> <tr> <th>Covariance Type: <td>cluster <th> <td> </table> <table> <tr> <td> <th>coef <th>std err <th>t <th>P&gt;|t| <th>[0.025 <th>0.975] <tr> <th>Intercept <td> 319.7820 <td> 17.638 <td> 18.131 <td> 0.000 <td> 284.463 <td> 355.101 <tr> <th>post_2010 <td> -19.3816 <td> 9.892 <td> -1.959 <td> 0.055 <td> -39.189 <td> 0.426 <tr> <th>treated <td> 106.8289 <td> 23.385 <td> 4.568 <td> 0.000 <td> 60.001 <td> 153.657 <tr> <th>post_2010:treated <td> -7.4181 <td> 18.869 <td> -0.393 <td> 0.696 <td> -45.203 <td> 30.367 </table> <table> <tr> <th>Omnibus: <td>53.945 <th> Durbin-Watson: <td> 0.741 <tr> <th>Prob(Omnibus): <td> 0.000 <th> Jarque-Bera (JB): <td> 81.621 <tr> <th>Skew: <td> 0.965 <th> Prob(JB): <td>1.89e-18 <tr> <th>Kurtosis: <td> 4.380 <th> Cond. No. <td> 6.85 </table><br/><br/>Notes:<br/>[1] Standard Errors are robust to cluster correlation (cluster)</div> </div> </section> <section id=Exercise-6 > <h2 id=Exercise-6 >Exercise 6<a class=headerlink  href="#Exercise-6" title="Link to this heading">¶</a></h2> <p>In the preceding exercise, we did a simple pre-post / treated-control comparison. But one important limitation of these designs is that they do not allow us to test for <em>parallel trends</em>.</p> <p><strong>Plot</strong> a difference-in-difference model using data from 2000-2009 (inclusive) and from 2016-2018 (inclusive). Note this will have four different geometric components: a time trend for treated counties pre-2010, a time trend for control counties pre-2010, a time trend for treated counties post-2016 (include 2016), and a time trend for control counties post-2016 (include 2016).</p> <p>Do you see evidence of parallel trends for these two datasets? Does that make you feel more or less confident in your diff-in-diff estimates?</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[13]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >altair</span> <span class=k >as</span> <span class=nn >alt</span>

<span class=n >alt</span><span class=o >.</span><span class=n >data_transformers</span><span class=o >.</span><span class=n >enable</span><span class=p >(</span><span class=s2 >"data_server"</span><span class=p >)</span>
<span class=n >arrests_long</span> <span class=o >=</span> <span class=n >arrests</span><span class=p >[</span>
    <span class=n >arrests</span><span class=o >.</span><span class=n >YEAR</span><span class=o >.</span><span class=n >isin</span><span class=p >(</span><span class=nb >list</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=mi >2000</span><span class=p >,</span> <span class=mi >2010</span><span class=p >))</span> <span class=o >+</span> <span class=nb >list</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=mi >2016</span><span class=p >,</span> <span class=mi >2019</span><span class=p >)))</span>
<span class=p >]</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[14]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >grouped_means</span> <span class=o >=</span> <span class=n >arrests_long</span><span class=o >.</span><span class=n >groupby</span><span class=p >([</span><span class=s2 >"treated"</span><span class=p >,</span> <span class=s2 >"YEAR"</span><span class=p >],</span> <span class=n >as_index</span><span class=o >=</span><span class=kc >False</span><span class=p >)[</span>
    <span class=p >[</span><span class=s2 >"violent_rate"</span><span class=p >]</span>
<span class=p >]</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
<span class=n >scatter</span> <span class=o >=</span> <span class=p >(</span>
    <span class=n >alt</span><span class=o >.</span><span class=n >Chart</span><span class=p >(</span><span class=n >grouped_means</span><span class=p >)</span>
    <span class=o >.</span><span class=n >mark_point</span><span class=p >()</span>
    <span class=o >.</span><span class=n >encode</span><span class=p >(</span>
        <span class=n >x</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >X</span><span class=p >(</span><span class=s2 >"YEAR:Q"</span><span class=p >,</span> <span class=n >scale</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >Scale</span><span class=p >(</span><span class=n >zero</span><span class=o >=</span><span class=kc >False</span><span class=p >)),</span>
        <span class=n >y</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >Y</span><span class=p >(</span><span class=s2 >"violent_rate:Q"</span><span class=p >,</span> <span class=n >scale</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >Scale</span><span class=p >(</span><span class=n >zero</span><span class=o >=</span><span class=kc >False</span><span class=p >)),</span>
        <span class=n >color</span><span class=o >=</span><span class=s2 >"treated:N"</span><span class=p >,</span>
    <span class=p >)</span>
<span class=p >)</span>

<span class=n >scatter</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[14]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div id=altair-viz-185900feb344489dab44faf38c511a02 ></div> <script> var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG; (function(spec, embedOpt){ let outputDiv = document.currentScript.previousElementSibling; if (outputDiv.id !== "altair-viz-185900feb344489dab44faf38c511a02") { outputDiv = document.getElementById("altair-viz-185900feb344489dab44faf38c511a02"); } const paths = { "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext", "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext", "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext", "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext", }; function maybeLoadScript(lib, version) { var key = `${lib.replace("-", "")}_version`; return (VEGA_DEBUG[key] == version) ? Promise.resolve(paths[lib]) : new Promise(function(resolve, reject) { var s = document.createElement('script'); document.getElementsByTagName("head")[0].appendChild(s); s.async = true; s.onload = () => { VEGA_DEBUG[key] = version; return resolve(paths[lib]); }; s.onerror = () => reject(`Error loading script: ${paths[lib]}`); s.src = paths[lib]; }); } function showError(err) { outputDiv.innerHTML = `<div class=error  style="color:red;">${err}</div>`; throw err; } function displayChart(vegaEmbed) { vegaEmbed(outputDiv, spec, embedOpt) .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`)); } if(typeof define === "function" && define.amd) { requirejs.config({paths}); require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`)); } else { maybeLoadScript("vega", "5") .then(() => maybeLoadScript("vega-lite", "4.17.0")) .then(() => maybeLoadScript("vega-embed", "6")) .catch(showError) .then(() => displayChart(vegaEmbed)); } })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"url": "http://localhost:62182/1e82e4581f044a6c0550835669830573.json"}, "mark": "point", "encoding": {"color": {"field": "treated", "type": "nominal"}, "x": {"field": "YEAR", "scale": {"zero": false}, "type": "quantitative"}, "y": {"field": "violent_rate", "scale": {"zero": false}, "type": "quantitative"}}, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json"}, {"mode": "vega-lite"}); </script></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[15]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >loesses</span> <span class=o >=</span> <span class=p >[]</span>
<span class=n >colors</span> <span class=o >=</span> <span class=p >{</span><span class=mi >0</span><span class=p >:</span> <span class=s2 >"lightblue"</span><span class=p >,</span> <span class=mi >1</span><span class=p >:</span> <span class=s2 >"orange"</span><span class=p >}</span>
<span class=k >for</span> <span class=n >t</span><span class=p >,</span> <span class=n >p</span> <span class=ow >in</span> <span class=p >[(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >0</span><span class=p >),</span> <span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >),</span> <span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=mi >0</span><span class=p >),</span> <span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=mi >1</span><span class=p >)]:</span>
    <span class=n >c</span> <span class=o >=</span> <span class=p >(</span>
        <span class=n >alt</span><span class=o >.</span><span class=n >Chart</span><span class=p >(</span>
            <span class=n >arrests_long</span><span class=p >[</span>
                <span class=p >(</span><span class=n >arrests_long</span><span class=p >[</span><span class=s2 >"treated"</span><span class=p >]</span> <span class=o >==</span> <span class=n >t</span><span class=p >)</span> <span class=o >&amp;</span> <span class=p >(</span><span class=n >arrests_long</span><span class=p >[</span><span class=s2 >"post_2010"</span><span class=p >]</span> <span class=o >==</span> <span class=n >p</span><span class=p >)</span>
            <span class=p >]</span>
        <span class=p >)</span>
        <span class=o >.</span><span class=n >encode</span><span class=p >(</span>
            <span class=n >x</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >X</span><span class=p >(</span><span class=s2 >"YEAR:Q"</span><span class=p >,</span> <span class=n >scale</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >Scale</span><span class=p >(</span><span class=n >zero</span><span class=o >=</span><span class=kc >False</span><span class=p >)),</span>
            <span class=n >y</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >Y</span><span class=p >(</span><span class=s2 >"violent_rate:Q"</span><span class=p >,</span> <span class=n >scale</span><span class=o >=</span><span class=n >alt</span><span class=o >.</span><span class=n >Scale</span><span class=p >(</span><span class=n >zero</span><span class=o >=</span><span class=kc >False</span><span class=p >)),</span>
        <span class=p >)</span>
        <span class=o >.</span><span class=n >transform_regression</span><span class=p >(</span><span class=s2 >"YEAR"</span><span class=p >,</span> <span class=s2 >"violent_rate"</span><span class=p >)</span>
        <span class=o >.</span><span class=n >mark_line</span><span class=p >(</span><span class=n >color</span><span class=o >=</span><span class=n >colors</span><span class=p >[</span><span class=n >t</span><span class=p >])</span>
    <span class=p >)</span>
    <span class=n >loesses</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >c</span><span class=p >)</span>


<span class=n >alt</span><span class=o >.</span><span class=n >layer</span><span class=p >(</span><span class=o >*</span><span class=n >loesses</span><span class=p >,</span> <span class=n >scatter</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[15]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div id=altair-viz-c369fc7406c54bb7bf4cb1ae36ddadfe ></div> <script> var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG; (function(spec, embedOpt){ let outputDiv = document.currentScript.previousElementSibling; if (outputDiv.id !== "altair-viz-c369fc7406c54bb7bf4cb1ae36ddadfe") { outputDiv = document.getElementById("altair-viz-c369fc7406c54bb7bf4cb1ae36ddadfe"); } const paths = { "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext", "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext", "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext", "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext", }; function maybeLoadScript(lib, version) { var key = `${lib.replace("-", "")}_version`; return (VEGA_DEBUG[key] == version) ? Promise.resolve(paths[lib]) : new Promise(function(resolve, reject) { var s = document.createElement('script'); document.getElementsByTagName("head")[0].appendChild(s); s.async = true; s.onload = () => { VEGA_DEBUG[key] = version; return resolve(paths[lib]); }; s.onerror = () => reject(`Error loading script: ${paths[lib]}`); s.src = paths[lib]; }); } function showError(err) { outputDiv.innerHTML = `<div class=error  style="color:red;">${err}</div>`; throw err; } function displayChart(vegaEmbed) { vegaEmbed(outputDiv, spec, embedOpt) .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`)); } if(typeof define === "function" && define.amd) { requirejs.config({paths}); require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`)); } else { maybeLoadScript("vega", "5") .then(() => maybeLoadScript("vega-lite", "4.17.0")) .then(() => maybeLoadScript("vega-embed", "6")) .catch(showError) .then(() => displayChart(vegaEmbed)); } })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "layer": [{"data": {"url": "http://localhost:62182/4a5ed51513d647e2e27d8814836ed87d.json"}, "mark": {"type": "line", "color": "lightblue"}, "encoding": {"x": {"field": "YEAR", "scale": {"zero": false}, "type": "quantitative"}, "y": {"field": "violent_rate", "scale": {"zero": false}, "type": "quantitative"}}, "transform": [{"on": "YEAR", "regression": "violent_rate"}]}, {"data": {"url": "http://localhost:62182/18bb5a69222cf20b71ce422f17741d27.json"}, "mark": {"type": "line", "color": "lightblue"}, "encoding": {"x": {"field": "YEAR", "scale": {"zero": false}, "type": "quantitative"}, "y": {"field": "violent_rate", "scale": {"zero": false}, "type": "quantitative"}}, "transform": [{"on": "YEAR", "regression": "violent_rate"}]}, {"data": {"url": "http://localhost:62182/117af43bf268d464e45845294578bf6b.json"}, "mark": {"type": "line", "color": "orange"}, "encoding": {"x": {"field": "YEAR", "scale": {"zero": false}, "type": "quantitative"}, "y": {"field": "violent_rate", "scale": {"zero": false}, "type": "quantitative"}}, "transform": [{"on": "YEAR", "regression": "violent_rate"}]}, {"data": {"url": "http://localhost:62182/27e0975219185b6584716a7f0321fcb7.json"}, "mark": {"type": "line", "color": "orange"}, "encoding": {"x": {"field": "YEAR", "scale": {"zero": false}, "type": "quantitative"}, "y": {"field": "violent_rate", "scale": {"zero": false}, "type": "quantitative"}}, "transform": [{"on": "YEAR", "regression": "violent_rate"}]}, {"data": {"url": "http://localhost:62182/1e82e4581f044a6c0550835669830573.json"}, "mark": "point", "encoding": {"color": {"field": "treated", "type": "nominal"}, "x": {"field": "YEAR", "scale": {"zero": false}, "type": "quantitative"}, "y": {"field": "violent_rate", "scale": {"zero": false}, "type": "quantitative"}}}], "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json"}, {"mode": "vega-lite"}); </script></div> </div> </section> <section id=Exercise-7 > <h2 id=Exercise-7 >Exercise 7<a class=headerlink  href="#Exercise-7" title="Link to this heading">¶</a></h2> <p>While we can estimate the model described above precisely as a regression, it’s actually much easier to estimate a more flexible model by running the regression we ran in Exercise 5 but with both <code class="docutils literal notranslate"><span class=pre >county</span></code> and <code class="docutils literal notranslate"><span class=pre >year</span></code> fixed effects. Use <code class="docutils literal notranslate"><span class=pre >PanelOLS</span></code> (or <code class="docutils literal notranslate"><span class=pre >lfe</span></code> in R) to estimate this fixed effects regression.</p> <p>With all these additional fixed effects, do you find evidence that marijuana legalization reduced violent crime?</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[16]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># NOTE TO GRADERS: It's not clear which dataset people will do this</span>
<span class=c1 ># with -- the data from Eq 5, or hte longer dataset from the previous question.</span>
<span class=c1 ># Both are fine. Answers for both here.</span>

<span class=c1 ># NOTE TO GRADERS 2: I _thought_ that PanelOLS clustered errors automatically.</span>
<span class=c1 ># It does NOT. You have to tell it to cluster in the</span>
<span class=c1 ># .fit() method—e.g., `.fit(cov_type="clustered", cluster_entity=True)`.</span>
<span class=c1 ># I mislead some students on this (this is in 2023), so if they don't</span>
<span class=c1 ># do this and get smaller SEs that's not their fault.</span>
</pre></div> </div> </div> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[17]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >from</span> <span class=nn >linearmodels</span> <span class=kn >import</span> <span class=n >PanelOLS</span>

<span class=n >arrests_for_panelols</span> <span class=o >=</span> <span class=n >arrests_sub</span><span class=o >.</span><span class=n >set_index</span><span class=p >([</span><span class=s2 >"COUNTY"</span><span class=p >,</span> <span class=s2 >"YEAR"</span><span class=p >])</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[18]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >mod</span> <span class=o >=</span> <span class=n >PanelOLS</span><span class=o >.</span><span class=n >from_formula</span><span class=p >(</span>
    <span class=s2 >"violent_rate ~ treated * post_2010 + EntityEffects + TimeEffects"</span><span class=p >,</span>
    <span class=n >data</span><span class=o >=</span><span class=n >arrests_for_panelols</span><span class=p >,</span>
    <span class=n >drop_absorbed</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
<span class=p >)</span><span class=o >.</span><span class=n >fit</span><span class=p >(</span><span class=n >cov_type</span><span class=o >=</span><span class=s2 >"clustered"</span><span class=p >,</span> <span class=n >cluster_entity</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span> <span class=n >cluster_time</span><span class=o >=</span><span class=kc >True</span><span class=p >)</span>
<span class=n >mod</span><span class=o >.</span><span class=n >summary</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/fs/h_8_rwsn5hvg9mhp0txgc_s9v6191b/T/ipykernel_96849/3310218310.py:1: AbsorbingEffectWarning:
Variables have been fully absorbed and have removed from the regression:

post_2010, treated

  mod = PanelOLS.from_formula(
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[18]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <table> <caption>PanelOLS Estimation Summary</caption> <tr> <th>Dep. Variable: <td>violent_rate <th> R-squared: <td>0.0013 <tr> <th>Estimator: <td>PanelOLS <th> R-squared (Between): <td>-0.0109 <tr> <th>No. Observations: <td>348 <th> R-squared (Within): <td>0.0155 <tr> <th>Date: <td>Mon, Mar 06 2023 <th> R-squared (Overall): <td>-0.0104 <tr> <th>Time: <td>14:04:40 <th> Log-likelihood <td>-1858.7 <tr> <th>Cov. Estimator: <td>Clustered <th> <td> <tr> <th> <td> <th> F-statistic: <td>0.3829 <tr> <th>Entities: <td>58 <th> P-value <td>0.5366 <tr> <th>Avg Obs: <td>6.0000 <th> Distribution: <td>F(1,284) <tr> <th>Min Obs: <td>6.0000 <th> <td> <tr> <th>Max Obs: <td>6.0000 <th> F-statistic (robust): <td>0.1899 <tr> <th> <td> <th> P-value <td>0.6633 <tr> <th>Time periods: <td>6 <th> Distribution: <td>F(1,284) <tr> <th>Avg Obs: <td>58.000 <th> <td> <tr> <th>Min Obs: <td>58.000 <th> <td> <tr> <th>Max Obs: <td>58.000 <th> <td> <tr> <th> <td> <th> <td> </table> <table> <caption>Parameter Estimates</caption> <tr> <td> <th>Parameter <th>Std. Err. <th>T-stat <th>P-value <th>Lower CI <th>Upper CI <tr> <th>post_2010:treated <td>-7.4181 <td>17.023 <td>-0.4358 <td>0.6633 <td>-40.925 <td>26.089 </table><br/><br/>F-test for Poolability: 17.282<br/>P-value: 0.0000<br/>Distribution: F(62,284)<br/><br/>Included effects: Entity, Time</div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[19]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># With longer data:</span>
<span class=n >arrests_for_panelols</span> <span class=o >=</span> <span class=n >arrests_long</span><span class=o >.</span><span class=n >set_index</span><span class=p >([</span><span class=s2 >"COUNTY"</span><span class=p >,</span> <span class=s2 >"YEAR"</span><span class=p >])</span>
<span class=n >arrests_long</span><span class=o >.</span><span class=n >YEAR</span><span class=o >.</span><span class=n >value_counts</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[19]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
2000    58
2001    58
2002    58
2003    58
2004    58
2005    58
2006    58
2007    58
2008    58
2009    58
2016    58
2017    58
2018    58
Name: YEAR, dtype: int64
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[20]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># model with fixed effect</span>
<span class=n >mod</span> <span class=o >=</span> <span class=n >PanelOLS</span><span class=o >.</span><span class=n >from_formula</span><span class=p >(</span>
    <span class=s2 >"violent_rate ~ treated * post_2010 + TimeEffects + EntityEffects"</span><span class=p >,</span>
    <span class=n >data</span><span class=o >=</span><span class=n >arrests_for_panelols</span><span class=p >,</span>
    <span class=n >drop_absorbed</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
<span class=p >)</span>
<span class=nb >print</span><span class=p >(</span><span class=n >mod</span><span class=o >.</span><span class=n >fit</span><span class=p >(</span><span class=n >cov_type</span><span class=o >=</span><span class=s2 >"clustered"</span><span class=p >,</span> <span class=n >cluster_entity</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span> <span class=n >cluster_time</span><span class=o >=</span><span class=kc >True</span><span class=p >))</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
                          PanelOLS Estimation Summary
================================================================================
Dep. Variable:           violent_rate   R-squared:                        0.0097
Estimator:                   PanelOLS   R-squared (Between):             -0.0168
No. Observations:                 754   R-squared (Within):               0.0588
Date:                Mon, Mar 06 2023   R-squared (Overall):             -0.0150
Time:                        14:04:40   Log-likelihood                   -4108.4
Cov. Estimator:             Clustered
                                        F-statistic:                      6.6568
Entities:                          58   P-value                           0.0101
Avg Obs:                       13.000   Distribution:                   F(1,683)
Min Obs:                       13.000
Max Obs:                       13.000   F-statistic (robust):             2.6634
                                        P-value                           0.1031
Time periods:                      13   Distribution:                   F(1,683)
Avg Obs:                       58.000
Min Obs:                       58.000
Max Obs:                       58.000

                                 Parameter Estimates
=====================================================================================
                   Parameter  Std. Err.     T-stat    P-value    Lower CI    Upper CI
-------------------------------------------------------------------------------------
post_2010:treated    -26.362     16.153    -1.6320     0.1031     -58.078      5.3540
=====================================================================================

F-test for Poolability: 41.619
P-value: 0.0000
Distribution: F(69,683)

Included effects: Entity, Time
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/fs/h_8_rwsn5hvg9mhp0txgc_s9v6191b/T/ipykernel_96849/3654453326.py:7: AbsorbingEffectWarning:
Variables have been fully absorbed and have removed from the regression:

post_2010, treated

  print(mod.fit(cov_type="clustered", cluster_entity=True, cluster_time=True))
</pre></div></div> </div> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2022, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.2.6. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
<!DOCTYPE html> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=generator  content="Docutils 0.17.1: http://docutils.sourceforge.net/" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151397036-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-151397036-1'); </script> <title>Matching Exercise &#8212; Unifying Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="../_static/material.css" /> <script data-url_root="../" id=documentation_options  src="../_static/documentation_options.js"></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel="shortcut icon" href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#exercises/exercise_matching" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Unifying Data Science" class="md-header-nav__button md-logo"> <img src="../_static/mids_logo.svg" height=26  alt="Unifying Data Science logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Unifying Data Science</span> <span class=md-header-nav__topic > Matching Exercise </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=Search  autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Unifying Data Science" class="md-nav__button md-logo"> <img src="../_static/mids_logo.svg" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Unifying Data Science">Unifying Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >CLASS SCHEDULE</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Causal Inference</span></span> <li class=md-nav__item > <a href="../limitations_of_ATE.html" class=md-nav__link >Limitations of ATE</a> <li class=md-nav__item > <a href="../internal_v_external_validity.html" class=md-nav__link >Internal v. External Validity</a> <li class=md-nav__item > <a href="../evaluating_real_studies.html" class=md-nav__link >Evaluating A Real Study</a> <li class=md-nav__item > <a href="../causal_inference_beyond_ab_testing.html" class=md-nav__link >Beyond AB Testing</a> <li class=md-nav__item > <a href="../matching_why.html" class=md-nav__link >Matching (Why)</a> <li class=md-nav__item > <a href="../matching_how.html" class=md-nav__link >Matching (How)</a> <li class=md-nav__item > <a href="../interpreting_indicator_vars.html" class=md-nav__link >Indicator Variables</a> <li class=md-nav__item > <a href="../fixed_effects.html" class=md-nav__link >Fixed Effects (FEs)</a> <li class=md-nav__item > <a href="../fixed_effects_and_causal_inference.html" class=md-nav__link >FEs & Causality</a> <li class=md-nav__item > <a href="../fixed_effects_v_hierarchical.html" class=md-nav__link >FEs & Hierarchical Models</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Data Science Project Design</span></span> <li class=md-nav__item > <a href="../backwards_design.html" class=md-nav__link >Backwards Design</a> <li class=md-nav__item > <a href="../taxonomy_of_questions.html" class=md-nav__link >Taxonomy of Questions</a> <li class=md-nav__item > <a href="../moving_from_problems_to_questions.html" class=md-nav__link >From Problems to Questions</a> <li class=md-nav__item > <a href="../descriptive_questions.html" class=md-nav__link >Discretion and Description</a> <li class=md-nav__item > <a href="../ethical_ml_recommendations.html" class=md-nav__link >Ethical Machine Learning</a> <li class=md-nav__item > <a href="../writing_to_stakeholders.html" class=md-nav__link >Writing for Lay Audiences</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >Contents</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#exercises-exercise-matching--page-root" class=md-nav__link >Matching Exercise</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Matching-Packages:-Python-v.-R" class=md-nav__link >Matching Packages: Python v. R</a> <li class=md-nav__item ><a href="#Installing-dame-flame." class=md-nav__link >Installing dame-flame.</a> <li class=md-nav__item ><a href="#Data-Setup" class=md-nav__link >Data Setup</a> <li class=md-nav__item ><a href="#Getting-To-Know-Your-Data" class=md-nav__link >Getting To Know Your Data</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-1" class=md-nav__link >Exercise 1</a> <li class=md-nav__item ><a href="#Exercise-2" class=md-nav__link >Exercise 2</a> <li class=md-nav__item ><a href="#Exercise-3" class=md-nav__link >Exercise 3</a> </ul> </nav> <li class=md-nav__item ><a href="#Matching!" class=md-nav__link >Matching!</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-4" class=md-nav__link >Exercise 4</a> <li class=md-nav__item ><a href="#Exercise-5" class=md-nav__link >Exercise 5</a> </ul> </nav> <li class=md-nav__item ><a href="#Let’s-Do-Matching-with-DAME" class=md-nav__link >Let’s Do Matching with DAME</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-6" class=md-nav__link >Exercise 6</a> <li class=md-nav__item ><a href="#Exercise-7" class=md-nav__link >Exercise 7</a> </ul> </nav> <li class=md-nav__item ><a href="#Interpreting-DAME-output" class=md-nav__link >Interpreting DAME output</a> <li class=md-nav__item ><a href="#Exercise-8" class=md-nav__link >Exercise 8</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-9" class=md-nav__link >Exercise 9</a> <li class=md-nav__item ><a href="#Exercise-10" class=md-nav__link >Exercise 10</a> </ul> </nav> <li class=md-nav__item ><a href="#Getting-Back-a-Dataset" class=md-nav__link >Getting Back a Dataset</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-11" class=md-nav__link >Exercise 11</a> </ul> </nav> <li class=md-nav__item ><a href="#Check-Your-Matches-and-Analyze" class=md-nav__link >Check Your Matches and Analyze</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Exercise-12" class=md-nav__link >Exercise 12</a> <li class=md-nav__item ><a href="#Exercise-13" class=md-nav__link >Exercise 13</a> <li class=md-nav__item ><a href="#Exercise-14" class=md-nav__link >Exercise 14</a> <li class=md-nav__item ><a href="#Exercise-15" class=md-nav__link >Exercise 15</a> <li class=md-nav__item ><a href="#Exercise-16" class=md-nav__link >Exercise 16</a> </ul> </nav> <li class=md-nav__item ><a href="#Other-Forms-of-Matching" class=md-nav__link >Other Forms of Matching</a> <li class=md-nav__item ><a href="#Absolutely-positively-need-the-solutions?" class=md-nav__link >Absolutely positively need the solutions?</a> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <section id=Matching-Exercise > <h1 id=exercises-exercise-matching--page-root >Matching Exercise<a class=headerlink  href="#exercises-exercise-matching--page-root" title="Permalink to this headline">¶</a></h1> <p>In this exercise, we’ll be evaluating how getting a college degree impacts earnings in the US using matching.</p> <section id="Matching-Packages:-Python-v.-R"> <h2 id="Matching-Packages:-Python-v.-R">Matching Packages: Python v. R<a class=headerlink  href="#Matching-Packages:-Python-v.-R" title="Permalink to this headline">¶</a></h2> <p>Just as the best tools for machine learning tend to be in Python since they’re developed by CS people (who prefer Python), most of the best tools for causal inference are implemented in R since innovation in causal inference tends to be lead by social scientists using R. As a result, the most well developed matching package is called <a class="reference external" href="https://kosukeimai.github.io/MatchIt/index.html">MatchIt</a>, and is only available in R (though you can always call it from Python using <code class="docutils literal notranslate"><span class=pre >rpy2</span></code>).</p> <p>In the last couple years, though, a group of computer scientists and statisticians here at Duke have made some great advancements in matching (especially the computational side of things), and they recently released a set of matching packages in both R and Python that we’ll be using today. They have some great algorithms we’ll use today, but be aware these packages aren’t as mature, and aren’t general purpose packages yet. So if you ever get deep into matching, be aware you will probably still want to make at least partial use of the R package <a class="reference external" href="https://kosukeimai.github.io/MatchIt/index.html">MatchIt</a>, as well as some other R packages for new innovative techniques (like <a class="reference external" href="https://projects.iq.harvard.edu/frontier/home">Matching Frontier estimation</a>), or <a class="reference external" href="https://almost-matching-exactly.github.io/AHB-R-package/">Adaptive Hyper-Box Matching</a>.</p> </section> <section id=Installing-dame-flame. > <h2 id=Installing-dame-flame. >Installing dame-flame.<a class=headerlink  href="#Installing-dame-flame." title="Permalink to this headline">¶</a></h2> <p>For this lesson, begin by installing <code class="docutils literal notranslate"><span class=pre >dame-flame</span></code> with <code class="docutils literal notranslate"><span class=pre >pip</span> <span class=pre >install</span> <span class=pre >dame-flame</span></code> (it’s not on conda yet).</p> <p><a class="reference external" href="https://almost-matching-exactly.github.io/DAME-FLAME-Python-Package">DAME</a> is an algorithm that we can use for a version of course exact matching. The package only accepts a list of categorical variables, and then attempts to match pairs that match exactly on those variables. That means that if you want to match on, say, age, you have to break it up into categories (say, under 18, 18-29, 30-39, etc. etc.).</p> <p>Of course, one cannot always find exact matches on all variables, so what DAME does is:</p> <ol class="arabic simple"> <li><p>Find all observations that match on <em>all</em> matching variables.</p> <li><p>Figure out which matching variable is least useful in predicting the outcome of interest <span class="math notranslate nohighlight">\(Y\)</span> and drops that, then tries to match the remaining observations on the narrowed set of matching variables.</p> <li><p>This repeats until you run out of variables, all observations are matched, or you hit a stopping run (namely: quality of matches falls below a threshold).</p> </ol> <p>In addition, the lab has also created FLAME, which does the same thing, but employs some tricks to make it <em>massively</em> more computationally efficient, meaning it can be used on datasets with millions of observations (which most matching algorithms cannot). It’s a little less accurate, but an amazing contribution never the less.</p> </section> <section id=Data-Setup > <h2 id=Data-Setup >Data Setup<a class=headerlink  href="#Data-Setup" title="Permalink to this headline">¶</a></h2> <p>To save you some time and let you focus on matching, I’ve <em>pre-cleaned</em> about one month worth of of data from the US Current Population Survey data we used for our <a class="reference external" href="exercises/exercises_regression_incomeineq.ipynb">gender discrimination analysis</a>. You can download the data <a class="reference external" href="https://github.com/nickeubank/MIDS_Data/blob/master/Current_Population_Survey/cps_for_matching.dta?raw=true%22">from here</a>, or read it directly with:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=n >cps</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_stata</span><span class=p >(</span>
    <span class=s2 >"https://github.com/nickeubank/MIDS_Data/blob/master"</span>
    <span class=s2 >"/Current_Population_Survey/cps_for_matching.dta?raw=true"</span>
<span class=p >)</span>
</pre></div> </div> <p>Load the data and quickly familiarize yourself with its contents.</p> </section> <section id=Getting-To-Know-Your-Data > <h2 id=Getting-To-Know-Your-Data >Getting To Know Your Data<a class=headerlink  href="#Getting-To-Know-Your-Data" title="Permalink to this headline">¶</a></h2> <p>Before you start matching, it is important to examine your data to ensure that matching is feasible (you have some overlap the the features of people in the treated and untreated groups), and also that there is a reason <em>to</em> match: either you’re unsure about some of the functional forms at play, or your have some imbalance between the two groups.</p> <section id=Exercise-1 > <h3 id=Exercise-1 >Exercise 1<a class=headerlink  href="#Exercise-1" title="Permalink to this headline">¶</a></h3> <p>Show the raw difference of <code class="docutils literal notranslate"><span class=pre >annual_earnings</span></code> between those with and without a college degree (<code class="docutils literal notranslate"><span class=pre >has_college</span></code>). Is the difference statistically significant?</p> </section> <section id=Exercise-2 > <h3 id=Exercise-2 >Exercise 2<a class=headerlink  href="#Exercise-2" title="Permalink to this headline">¶</a></h3> <p>Next we can check for balance. Check the share of people in different racial groups who have college degrees. Are those differences statistically significant?</p> <p>Does the distribution also look different across counties (I don’t need statistical significance for this)?</p> <p>Does the data seem balanced?</p> </section> <section id=Exercise-3 > <h3 id=Exercise-3 >Exercise 3<a class=headerlink  href="#Exercise-3" title="Permalink to this headline">¶</a></h3> <p>One of the other advantages of matching is that even when you have balanced data, you don’t have to go through the process of testing out different functional forms to see what fits the data base.</p> <p>In our last exercise, we looked at the relationship between gender and earnings “controlling for age”, where we just put in age as a linear control. Plot a non-linear regression of annual_earnings on age (if you’re using <code class="docutils literal notranslate"><span class=pre >plotnine</span></code>, use <code class="docutils literal notranslate"><span class=pre >geom_smooth(method="lowess")</span></code> — if you’re using altair, use <code class="docutils literal notranslate"><span class=pre >transform_loess</span></code> (<a class="reference external" href="https://www.practicaldatascience.org/html/plotting_altair_part1.html#LOESS">tutorial examples here</a>)).</p> <p>Does the relationship look linear?</p> <p>Does this speak to why it’s nice to not have to think about functional forms with matching as much?</p> </section> </section> <section id="Matching!"> <h2 id="Matching!">Matching!<a class=headerlink  href="#Matching!" title="Permalink to this headline">¶</a></h2> <p>Because DAME is an implementation of exact matching, we have to discretize all of our continuous variables. Thankfully, in this case we only have <code class="docutils literal notranslate"><span class=pre >age</span></code>, so this shouldn’t be too hard!</p> <section id=Exercise-4 > <h3 id=Exercise-4 >Exercise 4<a class=headerlink  href="#Exercise-4" title="Permalink to this headline">¶</a></h3> <p>Create a new variable that discretizes age into a single value for each decade of age.</p> <p>Because CPS only has employment data on people 18 or over, though, include people who are 18 or 19 with the 20 year olds so that group isn’t too small, and if you see any other really small groups, please merge those too.</p> </section> <section id=Exercise-5 > <h3 id=Exercise-5 >Exercise 5<a class=headerlink  href="#Exercise-5" title="Permalink to this headline">¶</a></h3> <p>We also have to covert our string variables into numeric variables for DAME, so convert <code class="docutils literal notranslate"><span class=pre >county</span></code> and <code class="docutils literal notranslate"><span class=pre >class94</span></code> to a numeric vector of intergers.</p> <p>(Note: it’s not clear whether <code class="docutils literal notranslate"><span class=pre >class94</span></code> belongs: if it reflects people choosing fields based on passion, it belongs; if people choose certain jobs because of their degrees, its not something we’d actually want in our regression.</p> <p>Hint: if you use <code class="docutils literal notranslate"><span class=pre >pd.Categorical</span></code> to convert you var to a categorical, you can pull the underlying integer codes with <code class="docutils literal notranslate"><span class=pre >.codes</span></code>.</p> </section> </section> <section id="Let’s-Do-Matching-with-DAME"> <h2 id="Let’s-Do-Matching-with-DAME">Let’s Do Matching with DAME<a class=headerlink  href="#Let’s-Do-Matching-with-DAME" title="Permalink to this headline">¶</a></h2> <section id=Exercise-6 > <h3 id=Exercise-6 >Exercise 6<a class=headerlink  href="#Exercise-6" title="Permalink to this headline">¶</a></h3> <p>First, drop all the variables you <em>don’t</em> want in matching (e.g. your original <code class="docutils literal notranslate"><span class=pre >age</span></code> variable), and any observations for which <code class="docutils literal notranslate"><span class=pre >annual_earnings</span></code> is missing.</p> <p>You will probably also have to drop a column named <code class="docutils literal notranslate"><span class=pre >index</span></code>: DAME will try and match on ANY included variables, and so because there was a column called <code class="docutils literal notranslate"><span class=pre >index</span></code> in the data we imported, if we leave it in DAME will try (and obviously fail) to match on index.</p> <p>Also, it’s best to reset your index, as <code class="docutils literal notranslate"><span class=pre >dame_flame</span></code> using index labels (e.g., the values in <code class="docutils literal notranslate"><span class=pre >df.index</span></code>) to identify matches. So you want to be sure those are unique.</p> </section> <section id=Exercise-7 > <h3 id=Exercise-7 >Exercise 7<a class=headerlink  href="#Exercise-7" title="Permalink to this headline">¶</a></h3> <p>The syntax of <code class="docutils literal notranslate"><span class=pre >dame_flame</span></code> is similar to the syntax of <code class="docutils literal notranslate"><span class=pre >sklearn</span></code>. If you start with a dataset called <code class="docutils literal notranslate"><span class=pre >my_data</span></code> with a <code class="docutils literal notranslate"><span class=pre >treat</span></code> variable with treatment assignment and an <code class="docutils literal notranslate"><span class=pre >outcome</span></code> variable for my outcome of interest (<span class="math notranslate nohighlight">\(Y\)</span>), the syntax to do basic matching would be:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >dame_flame</span>
<span class=n >model</span> <span class=o >=</span> <span class=n >dame_flame</span><span class=o >.</span><span class=n >matching</span><span class=o >.</span><span class=n >DAME</span><span class=p >(</span><span class=n >repeats</span><span class=o >=</span><span class=kc >False</span><span class=p >,</span> <span class=n >verbose</span><span class=o >=</span><span class=mi >3</span><span class=p >,</span> <span class=n >want_pe</span><span class=o >=</span><span class=kc >True</span><span class=p >)</span>
<span class=n >model</span><span class=o >.</span><span class=n >fit</span><span class=p >(</span>
    <span class=n >my_data</span><span class=p >,</span>
    <span class=n >treatment_column_name</span><span class=o >=</span><span class=s2 >"treat"</span><span class=p >,</span>
    <span class=n >outcome_column_name</span><span class=o >=</span><span class=s2 >"outcome"</span><span class=p >,</span>
<span class=p >)</span>
<span class=n >result</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >predict</span><span class=p >(</span><span class=n >my_data</span><span class=p >)</span>
</pre></div> </div> <p>Where the arguments:</p> <ul class=simple > <li><p><code class="docutils literal notranslate"><span class=pre >repeats=False</span></code> says that I only want each observation to get matched once. We’ll talk about what happens if we use <code class="docutils literal notranslate"><span class=pre >repeats=True</span></code> below.</p> <li><p><code class="docutils literal notranslate"><span class=pre >verbose=3</span></code> tells dame to report everything it’s doing as it goes.</p> <li><p><code class="docutils literal notranslate"><span class=pre >want_pe</span></code> says “please include the predictive error in your printout at each step”. This is a measure of match quality.</p> </ul> <p>So run DAME on your data!</p> </section> </section> <section id=Interpreting-DAME-output > <h2 id=Interpreting-DAME-output >Interpreting DAME output<a class=headerlink  href="#Interpreting-DAME-output" title="Permalink to this headline">¶</a></h2> <p>The output you get from doing this <em>should</em> be reports from about 8 iterations of matching. In each iteration, you’ll see a description of the number of matches made in the iteration, the number of treatment units still unmatched, and the number of control units unmatched.</p> <p>In the first iteration, the algorithm tries to match observations that match on <em>all</em> the variables in your data. That’s why in the first iteration, you see the set of variables being dropped is an empty set – it <em>hasn’t</em> dropped any variables:</p> <div class="highlight-none notranslate"><div class=highlight ><pre><span></span>Completed iteration 0 of matching
    Number of matched groups formed in total:  370
    Unmatched treated units:  644 out of a total of  1150 treated units
    Unmatched control units:  3187 out of a total of  4365 control units
    Number of matches made this iteration:  1684
    Number of matches made so far:  1684
    Covariates dropped so far:  set()
    Predictive error of covariate set used to match:  1199312680.0957854
</pre></div> </div> <p>But as we can see from this output, the algorithm found 1,684 perfect matches—pairs of observations (one treated, one untreated) that had <em>exactly</em> the same value of all the variables we included. But we also see we still have 644 <em>unmatched</em> treated units, so what do we do?</p> <p>The answer is that if we want to match more of our treatment variables, we have to try and match on a subset of our variables.</p> <p>But what variable should we drop? This is the secret sauce of DAME. DAME picks the variables to drop by trying to predict our outcome <span class="math notranslate nohighlight">\(Y\)</span> using all our variables (by default using a ridge regression), then it drops the matching variable that is contributing the least to that prediction. Since our goal in matching is to eliminate baseline differences (<span class="math notranslate nohighlight">\(E(Y_0|D=1) - E(Y_1|D=0)\)</span>), dropping the covariates least related to <span class="math notranslate nohighlight">\(Y\)</span> makes sense.</p> <p>As a result, in the second iteration (called iteration 1, since it uses 0-based indexing), we see that the variable it drops first is <code class="docutils literal notranslate"><span class=pre >county</span></code>, and it’s subsequently able to make another 3,626 new matches on the remaining variables!</p> <div class="highlight-none notranslate"><div class=highlight ><pre><span></span>Completed iteration 1 of matching
    Number of matched groups formed in total:  494
    Unmatched treated units:  25 out of a total of  1150 treated units
    Unmatched control units:  180 out of a total of  4365 control units
    Number of matches made this iteration:  3626
    Number of matches made so far:  5310
    Covariates dropped so far:  frozenset({'county'})
    Predictive error of covariate set used to match:  1199421883.1095908
</pre></div> </div> <p>And so DAME continues until after 8 iterations, it’s matched all treated observations.</p> </section> <section id=Exercise-8 > <h2 id=Exercise-8 >Exercise 8<a class=headerlink  href="#Exercise-8" title="Permalink to this headline">¶</a></h2> <p>Congratulations! You just on your first one-to-many matching!</p> <p>The next step is to think about which of the matches that DAME generated are good enough for inclusion in our analysis. As you may recall, one of the choices you have to make as a researcher when doing matching is how “good” a match has to be in order to be included in your final data set. By default, DAME will keep dropping matching variables until it has been able to match all the treated observations or runs out of variables. It will do this no matter how bad the matches start to become – if it ends up with the treated observation and a control observation that can only be matched on gender, it will match them just on gender, even though we probably don’t think that that’s a “good” match.</p> <p>The way to control this behavior is to tell DAME when to stop manually using the <code class="docutils literal notranslate"><span class=pre >early_stop_iterations</span></code> argument to tell the matching algorithm when to stop.</p> <p>So when is a good time to stop? There’s no objective or “right” answer to that question. It fundamentally comes down to a trade-off between bias (which gets higher is you allow more low quality matches into your data) and variance (which will go down as you increase the number of matches you keep).</p> <p>But one way to start the process of picking a cut point is to examine how the quality of matches evolves over iterations. DAME keeps this information in <code class="docutils literal notranslate"><span class=pre >model.pe_each_iter</span></code>. This shows, for each iteration, the “prediction error” resulting from dropping the variables excluded in each step. This “prediction error” is the difference in the mean-squared error of regressing <span class="math notranslate nohighlight">\(Y\)</span> on our matching variables (by default in a ridge regression) with all variables versus with the subset being used for matching in a given iteration. By design, of course, this is always increasing.</p> <p>To see how this evolves, plot your <code class="docutils literal notranslate"><span class=pre >pe</span></code> against iteration numbers. You can also see the <code class="docutils literal notranslate"><span class=pre >pe</span></code> values for each iteration reported in the output from when DAME ran above if you want to make your you’re lining up the errors with iterations right.</p> <p>Are there any points where the match quality seems to fall off dramatically?</p> <section id=Exercise-9 > <h3 id=Exercise-9 >Exercise 9<a class=headerlink  href="#Exercise-9" title="Permalink to this headline">¶</a></h3> <p>Suppose we want to ensure we have at least 5,000 observations in our matched data—where might you cut off the data to get a sample size of at least that but before a big quality falloff?</p> </section> <section id=Exercise-10 > <h3 id=Exercise-10 >Exercise 10<a class=headerlink  href="#Exercise-10" title="Permalink to this headline">¶</a></h3> <p>Re-run your matching, stopping at the point you picked above using <code class="docutils literal notranslate"><span class=pre >early_stop_iterations</span></code>.</p> </section> </section> <section id=Getting-Back-a-Dataset > <h2 id=Getting-Back-a-Dataset >Getting Back a Dataset<a class=headerlink  href="#Getting-Back-a-Dataset" title="Permalink to this headline">¶</a></h2> <p>OK, my one current complaint with DAME is that it doesn’t just give you back a nice dataset of your matches for analysis. If we look at our results – <code class="docutils literal notranslate"><span class=pre >matches</span></code> – it’s <em>almost</em> what we want, except it’s dropped our treatment and outcome columns, and it’s put a string <code class="docutils literal notranslate"><span class=pre >*</span></code> in any entry where a value <em>wasn’t</em> used for matching:</p> <div class="highlight-none notranslate"><div class=highlight ><pre><span></span>  female simplified_race   county   class94   discretized_age
0  1.0     0.0              10.0      3.0          5.0
1  0.0     2.0              *         3.0          3.0
2  0.0     0.0              8.0        3.0         6.0
3  0.0     0.0              *         1.0          4.0
4  0.0     0.0              24.0      3.0          3.0
</pre></div> </div> <p>So for now (though I think this will get updated in the package), we’ll have to do it ourselves! Just copy-paste this:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=k >def</span> <span class=nf >get_dataframe</span><span class=p >(</span><span class=n >model</span><span class=p >,</span> <span class=n >result_of_fit</span><span class=p >):</span>

    <span class=c1 ># Get original data</span>
    <span class=n >better</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >input_data</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >result_of_fit</span><span class=o >.</span><span class=n >index</span><span class=p >]</span>
    <span class=k >if</span> <span class=ow >not</span> <span class=n >better</span><span class=o >.</span><span class=n >index</span><span class=o >.</span><span class=n >is_unique</span><span class=p >:</span>
        <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"Need index values in input data to be unique"</span><span class=p >)</span>

    <span class=c1 ># Get match groups for clustering</span>
    <span class=n >better</span><span class=p >[</span><span class=s2 >"match_group"</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span>
    <span class=n >better</span><span class=p >[</span><span class=s2 >"match_group_size"</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span>
    <span class=k >for</span> <span class=n >idx</span><span class=p >,</span> <span class=n >group</span> <span class=ow >in</span> <span class=nb >enumerate</span><span class=p >(</span><span class=n >model</span><span class=o >.</span><span class=n >units_per_group</span><span class=p >):</span>
        <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >group</span><span class=p >,</span> <span class=s2 >"match_group"</span><span class=p >]</span> <span class=o >=</span> <span class=n >idx</span>
        <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >group</span><span class=p >,</span> <span class=s2 >"match_group_size"</span><span class=p >]</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >group</span><span class=p >)</span>

    <span class=c1 ># Get weights. I THINK this is right?! At least for with repeat=False?</span>
    <span class=n >t</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >treatment_column_name</span>
    <span class=n >better</span><span class=p >[</span><span class=s2 >"t_in_group"</span><span class=p >]</span> <span class=o >=</span> <span class=n >better</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=s2 >"match_group"</span><span class=p >)[</span><span class=n >t</span><span class=p >]</span><span class=o >.</span><span class=n >transform</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >sum</span><span class=p >)</span>

    <span class=c1 ># Make weights</span>
    <span class=n >better</span><span class=p >[</span><span class=s2 >"weights"</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span>
    <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >,</span> <span class=s2 >"weights"</span><span class=p >]</span> <span class=o >=</span> <span class=mi >1</span>  <span class=c1 ># treaments are 1</span>

    <span class=c1 ># Controls start as proportional to num of treatments</span>
    <span class=c1 ># each observation is matched to.</span>
    <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >,</span> <span class=s2 >"weights"</span><span class=p >]</span> <span class=o >=</span> <span class=n >better</span><span class=p >[</span><span class=s2 >"t_in_group"</span><span class=p >]</span> <span class=o >/</span> <span class=p >(</span>
        <span class=n >better</span><span class=p >[</span><span class=s2 >"match_group_size"</span><span class=p >]</span> <span class=o >-</span> <span class=n >better</span><span class=p >[</span><span class=s2 >"t_in_group"</span><span class=p >]</span>
    <span class=p >)</span>

    <span class=c1 ># Then re-normalize for num unique control observations.</span>
    <span class=n >control_weights</span> <span class=o >=</span> <span class=n >better</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >][</span><span class=s2 >"weights"</span><span class=p >]</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>

    <span class=n >num_control_obs</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >better</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >]</span><span class=o >.</span><span class=n >index</span><span class=o >.</span><span class=n >drop_duplicates</span><span class=p >())</span>
    <span class=n >renormalization</span> <span class=o >=</span> <span class=n >num_control_obs</span> <span class=o >/</span> <span class=n >control_weights</span>
    <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >,</span> <span class=s2 >"weights"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
        <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >,</span> <span class=s2 >"weights"</span><span class=p >]</span> <span class=o >*</span> <span class=n >renormalization</span>
    <span class=p >)</span>
    <span class=k >assert</span> <span class=n >better</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >notnull</span><span class=p >()</span><span class=o >.</span><span class=n >all</span><span class=p >()</span>

    <span class=n >better</span> <span class=o >=</span> <span class=n >better</span><span class=o >.</span><span class=n >drop</span><span class=p >([</span><span class=s2 >"t_in_group"</span><span class=p >],</span> <span class=n >axis</span><span class=o >=</span><span class=s2 >"columns"</span><span class=p >)</span>

    <span class=c1 ># Make sure right length and values!</span>
    <span class=k >assert</span> <span class=nb >len</span><span class=p >(</span><span class=n >result_of_fit</span><span class=p >)</span> <span class=o >==</span> <span class=nb >len</span><span class=p >(</span><span class=n >better</span><span class=p >)</span>
    <span class=k >assert</span> <span class=n >better</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >better</span><span class=p >[</span><span class=n >t</span><span class=p >]</span> <span class=o >==</span> <span class=mi >0</span><span class=p >,</span> <span class=s2 >"weights"</span><span class=p >]</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >==</span> <span class=n >num_control_obs</span>

    <span class=k >return</span> <span class=n >better</span>
</pre></div> </div> <section id=Exercise-11 > <h3 id=Exercise-11 >Exercise 11<a class=headerlink  href="#Exercise-11" title="Permalink to this headline">¶</a></h3> <p>Copy-paste that code and run it with your original data, your (fit) model, and what you got back when you ran <code class="docutils literal notranslate"><span class=pre >result_of_fit</span></code>. Then we’ll work with the output of that. You should get back a single dataframe of the same length as your original model.</p> </section> </section> <section id=Check-Your-Matches-and-Analyze > <h2 id=Check-Your-Matches-and-Analyze >Check Your Matches and Analyze<a class=headerlink  href="#Check-Your-Matches-and-Analyze" title="Permalink to this headline">¶</a></h2> <section id=Exercise-12 > <h3 id=Exercise-12 >Exercise 12<a class=headerlink  href="#Exercise-12" title="Permalink to this headline">¶</a></h3> <p>We previously tested balance on <code class="docutils literal notranslate"><span class=pre >simplified_race</span></code>, and by county. Check those again. Are there still statistically significant differences in college education by <code class="docutils literal notranslate"><span class=pre >simplified_race</span></code>?</p> <p>Note that when you test for this, you’ll need to take into account the <code class="docutils literal notranslate"><span class=pre >weights</span></code> column you got back from <code class="docutils literal notranslate"><span class=pre >get_dataframe</span></code>. What DAME does is not actually the 1-to-1 matching described in our readings – instead, however many observations that exact match it finds it puts in the same “group”. (These groups are identified in the dataframe you got from <code class="docutils literal notranslate"><span class=pre >get_dataframe</span></code> by the column <code class="docutils literal notranslate"><span class=pre >match_group</span></code>, and the size of each group is in <code class="docutils literal notranslate"><span class=pre >match_group_size</span></code>.)</p> <p>So to analyze the data, you need to use the <code class="docutils literal notranslate"><span class=pre >wls</span></code> (weighted least squares) function in <code class="docutils literal notranslate"><span class=pre >statsmodels</span></code>. For example, if your data is called <code class="docutils literal notranslate"><span class=pre >matched_data</span></code>, you might run:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=n >smf</span><span class=o >.</span><span class=n >wls</span><span class=p >(</span>
    <span class=s2 >"has_college ~ C(simplified_race)"</span><span class=p >,</span> <span class=n >matched_data</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >matched_data</span><span class=p >[</span><span class=s2 >"weights"</span><span class=p >]</span>
<span class=p >)</span><span class=o >.</span><span class=n >fit</span><span class=p >()</span><span class=o >.</span><span class=n >summary</span><span class=p >()</span>
</pre></div> </div> </section> <section id=Exercise-13 > <h3 id=Exercise-13 >Exercise 13<a class=headerlink  href="#Exercise-13" title="Permalink to this headline">¶</a></h3> <p>Now use a weighted least squares regression on your matched data to regress annual earnings on <em>just</em> having a college eduction. What is the apparent effect of a BA? How does that compare to our initial estimate using the raw CPS data (before matching)?</p> </section> <section id=Exercise-14 > <h3 id=Exercise-14 >Exercise 14<a class=headerlink  href="#Exercise-14" title="Permalink to this headline">¶</a></h3> <p>Now include our other matching variables as controls (e.g. all the coefficients you gave to DAME to use). Does the coefficient change?</p> </section> <section id=Exercise-15 > <h3 id=Exercise-15 >Exercise 15<a class=headerlink  href="#Exercise-15" title="Permalink to this headline">¶</a></h3> <p>If you stopped matching after the second iteration (Iteration 1) back in Exercise 10, you may be wondering if that was a good choice! Let’s check by restricting our attention to ONLY exact matches (<code class="docutils literal notranslate"><span class=pre >iteration</span> <span class=pre >=</span> <span class=pre >0</span></code>). Run that match.</p> </section> <section id=Exercise-16 > <h3 id=Exercise-16 >Exercise 16<a class=headerlink  href="#Exercise-16" title="Permalink to this headline">¶</a></h3> <p>Now use a weighted linear regression on your matched data to regress annual earnings on <em>just</em> having a college eduction. Is that different from what you had when you allowed more low quality matches?</p> </section> </section> <section id=Other-Forms-of-Matching > <h2 id=Other-Forms-of-Matching >Other Forms of Matching<a class=headerlink  href="#Other-Forms-of-Matching" title="Permalink to this headline">¶</a></h2> <p>OK, hopefully this gives you a taste of matching! There are, of course, <em>many</em> other permutations to be aware of though.</p> <ul class=simple > <li><p>Matching with replacement. In this exercise, we set <code class="docutils literal notranslate"><span class=pre >repeat=False</span></code>, so each observation could only end up in our final dataset once. However, if we use <code class="docutils literal notranslate"><span class=pre >repeat=True</span></code>, if an untreated observation is the closest observation to multiple treated observations, it may get put in the dataset multiple times. We can still use this dataset in <em>almost</em> the same way, though, except we have to make use of weights so that if an observation appears, say, twice, each observation has a weight that’s 1/2 the weight of an observation only appearing once.</p> <li><p>Matching with continuous variables: DAME is used for exact matching, but if you have lots of continuous variables, you can also match on those. In fact, the Almost Exact Matching Lab also has a library called <a class="reference external" href="https://almost-matching-exactly.github.io/MALTS/">MALTS</a> that will do matching with continuous variables. That package does something <em>like</em> Mahalanobis Distance matching, but ulike Mahalanobis, which calculates the distance between observations in terms of the difference in all the matching variables normalized by each matching variable’s standard deviation, MALTS does something much more clever. (Here’s <a class="reference external" href="https://arxiv.org/abs/1811.07415">the paper</a> describing the technique if you want all the details). Basically, it figures out how well each matching variable predicts our outcome <span class="math notranslate nohighlight">\(Y\)</span>, then weights the different variables by their predictive power instead of just normalizing by something arbitrary like their standard deviation. As a result, final matches will prioritize matching more closely on variables that are outcome-relevant. In addition, when it sees a categorical variable, it recognizes that and only pairs observations when they are an exact match on that categorical variable.</p> <li><p>If you’re dataset is huge, use <code class="docutils literal notranslate"><span class=pre >FLAME</span></code>: this dataset is small, but if you have lots of observations and lots of matching variable, the computational complexity of this task explodes, so the AEML created FLAME, which works with millions of observations at only a small cost to match quality.</p> </ul> </section> <section id="Absolutely-positively-need-the-solutions?"> <h2 id="Absolutely-positively-need-the-solutions?">Absolutely positively need the solutions?<a class=headerlink  href="#Absolutely-positively-need-the-solutions?" title="Permalink to this headline">¶</a></h2> <p><em>Don’t use this link until you’ve really, really spent time struggling with your code!</em> Doing so only results in you cheating yourself.</p> <p><a class="reference internal" href="../solutions_warning.html"><span class=doc >Link</span></a></p> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2022, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>